<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daytrading Journal Suite - Pro</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body class="app-shell">
    <div class="app-layout">
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="brand-icon"><span class="brand-mark">TJ</span></div>
                <div class="brand-text">
                    <span>Trade Journal</span>
                    <span class="brand-subtitle">Local Pro</span>
                </div>
            </div>
            <button class="btn btn-primary sidebar-cta" onclick="switchTab('new-trade')">‚ûï New Trade</button>
            <nav class="sidebar-nav">
                <button class="tab-btn active" data-tab="dashboard"><span class="nav-icon">üìà</span><span>Dashboard</span></button>
                <button class="tab-btn" data-tab="journal"><span class="nav-icon">üìí</span><span>Trades</span></button>
                <button class="tab-btn" data-tab="calendar"><span class="nav-icon">üóìÔ∏è</span><span>Calendar</span></button>
                <button class="tab-btn" data-tab="analytics"><span class="nav-icon">üìä</span><span>Analytics</span></button>
                <button class="tab-btn" data-tab="data-analysis"><span class="nav-icon">üßæ</span><span>Reports Hub</span></button>
                <button class="tab-btn" data-tab="playbook"><span class="nav-icon">üìö</span><span>Playbook</span></button>
                <button class="tab-btn" data-tab="rules"><span class="nav-icon">üìù</span><span>Rules & Notebook</span></button>
                <button class="tab-btn" data-tab="settings"><span class="nav-icon">‚öôÔ∏è</span><span>Settings</span></button>
                <button class="tab-btn tab-hidden" data-tab="new-trade" aria-hidden="true"></button>
            </nav>
            <div class="sidebar-footer">Local-only journal ¬∑ No cloud sync</div>
        </aside>
        <div class="app-main">
            <header class="topbar">
                <div class="topbar-left">
                    <div class="topbar-title">
                        <h1>Trading Journal Suite</h1>
                        <p>Disciplined trading, beautifully organized.</p>
                    </div>
                    <div class="account-block">
                        <div>
                            <label class="form-label" for="accountSelector">Account</label>
                            <div class="account-selector">
                                <select class="account-dropdown" id="accountSelector" onchange="switchAccount()">
                                    <option value="default">Main Account</option>
                                </select>
                            </div>
                        </div>
                        <div class="account-actions">
                            <span class="account-actions-label">Account actions</span>
                            <div class="segmented">
                                <button class="add-account-btn btn btn-ghost btn-small" onclick="addNewAccount()">Add</button>
                                <button class="add-account-btn btn btn-ghost btn-small" onclick="editAccount()">Edit</button>
                                <button class="add-account-btn btn btn-ghost btn-small" onclick="deleteAccount()">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="topbar-right">
                    <div class="date-range">
                        <label class="form-label" for="filterDateFrom">Date range</label>
                        <div class="date-inputs">
                            <input type="date" class="form-input" id="filterDateFrom" placeholder="From Date">
                            <span class="date-separator">‚Üí</span>
                            <input type="date" class="form-input" id="filterDateTo" placeholder="To Date">
                        </div>
                    </div>
                    <div class="topbar-actions">
                        <button class="btn btn-primary" onclick="switchTab('new-trade')">New Trade</button>
                        <button class="btn btn-ghost btn-small theme-toggle" id="themeToggle" onclick="toggleTheme()">üåì Theme</button>
                    </div>
                </div>
            </header>
            <div class="topbar-meta">
                <div class="stat-chip">
                    <div class="stat-label">Daily P&L</div>
                    <div class="stat-value positive" id="headerDailyPnL">+$0.00</div>
                </div>
                <div class="stat-chip">
                    <div class="stat-label">Weekly P&L</div>
                    <div class="stat-value positive" id="headerWeeklyPnL">+$0.00</div>
                </div>
                <div class="stat-chip">
                    <div class="stat-label">Win Rate</div>
                    <div class="stat-value" id="headerWinRate">0%</div>
                </div>
                <div class="stat-chip">
                    <div class="stat-label">Total Trades</div>
                    <div class="stat-value" id="headerTotalTrades">0</div>
                </div>
            </div>
            <main class="content">
        <!-- DASHBOARD TAB -->
        <div class="tab-content active" id="dashboard">
            <div class="kpi-grid">
                <div class="kpi-tile">
                    <div class="kpi-label">Net P/L</div>
                    <div class="kpi-value positive" id="totalPnL">$0.00</div>
                    <div class="kpi-meta" id="totalPnLChange">+0% this month</div>
                </div>
                <div class="kpi-tile">
                    <div class="kpi-label">Win Rate</div>
                    <div class="kpi-value" id="winRate">0%</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="winRateProgress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="kpi-tile">
                    <div class="kpi-label">Profit Factor</div>
                    <div class="kpi-value" id="profitFactor">0.00</div>
                    <div class="kpi-meta">Consistency index</div>
                </div>
                <div class="kpi-tile">
                    <div class="kpi-label">Avg Win</div>
                    <div class="kpi-value positive" id="avgWin">$0.00</div>
                    <div class="kpi-meta">Average per winner</div>
                </div>
                <div class="kpi-tile">
                    <div class="kpi-label">Avg Loss</div>
                    <div class="kpi-value negative" id="avgLoss">$0.00</div>
                    <div class="kpi-meta">Average per loser</div>
                </div>
                <div class="kpi-tile">
                    <div class="kpi-label">Trades Count</div>
                    <div class="kpi-value" id="totalTrades">0</div>
                    <div class="kpi-meta">Tracked trades</div>
                </div>
            </div>

            <div class="widget-grid">
                <div class="card span-8">
                    <div class="card-header">
                        <div>
                            <div class="card-title">P&L Performance</div>
                            <div class="card-subtitle">Cumulative equity curve and period trends</div>
                        </div>
                        <div class="chart-controls">
                            <button class="chart-btn active" onclick="switchPnLChart('daily')">Daily</button>
                            <button class="chart-btn" onclick="switchPnLChart('weekly')">Weekly</button>
                            <button class="chart-btn" onclick="switchPnLChart('monthly')">Monthly</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="modern-chart" id="pnlChart"></div>
                    </div>
                </div>

                <div class="card span-4 behavior-card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Behavior & Discipline</div>
                            <div class="card-subtitle">Plan adherence and rule impact</div>
                        </div>
                    </div>
                    <div class="behavior-grid">
                        <div class="behavior-item">
                            <div class="behavior-label">Compliance Score</div>
                            <div class="behavior-value" id="complianceScore">0%</div>
                            <div class="behavior-meta" id="violationRate">0% off-plan</div>
                        </div>
                        <div class="behavior-item">
                            <div class="behavior-label">Rule Break Cost</div>
                            <div class="behavior-value" id="violationCost">$0.00</div>
                            <div class="behavior-meta">Off-plan P/L impact</div>
                        </div>
                        <div class="behavior-item">
                            <div class="behavior-label">Max Drawdown</div>
                            <div class="behavior-value negative" id="maxDrawdown">$0.00</div>
                            <div class="behavior-meta" id="currentDrawdown">Current: $0.00</div>
                        </div>
                        <div class="behavior-item">
                            <div class="behavior-label">Expectancy</div>
                            <div class="behavior-value" id="dashboardExpectancy">$0.00</div>
                            <div class="behavior-meta" id="dashboardExpectancyMeta">Per trade</div>
                        </div>
                    </div>
                </div>

                <div class="card span-4">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Performance Calendar</div>
                            <div class="card-subtitle">Daily P/L intensity snapshot</div>
                        </div>
                    </div>
                    <div class="calendar-heatmap">
                        <div class="calendar-heatmap-legend" id="dashboardCalendarLegend"></div>
                        <div class="calendar-heatmap-grid" id="dashboardCalendarGrid"></div>
                    </div>
                    <div class="calendar-day-detail" id="dashboardDayDetail">
                        <div class="empty-state">
                            <span>üìÜ</span>
                            <div>Select a day to see trade summary</div>
                        </div>
                    </div>
                </div>

                <div class="card span-4">
                    <div class="card-header">
                        <div>
                            <div class="card-title">Recent Trades</div>
                            <div class="card-subtitle">Latest activity across this account</div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="recent-trades-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>P&L</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="recentTradesTable">
                                <tr>
                                    <td colspan="4">
                                        <div class="empty-state">
                                            <span>üì≠</span>
                                            <div>No trades yet</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card span-4">
                    <div class="card-header">
                        <div class="card-title">Top Performing Setups</div>
                    </div>
                    <div id="topSetups">
                        <div class="empty-state">
                            <span>üìà</span>
                            <div>No data yet</div>
                        </div>
                    </div>
                </div>

                <div class="card span-4">
                    <div class="card-header">
                        <div class="card-title">Today's Goals</div>
                    </div>
                    <div id="todayGoals">
                        <div class="empty-state">
                            <span>‚úÖ</span>
                            <div>Set your daily goals in Settings</div>
                        </div>
                    </div>
                </div>

                <div class="card span-4">
                    <div class="card-header">
                        <div class="card-title">Trading Streak</div>
                    </div>
                    <div class="streak-card">
                        <div class="streak-icon">üî•</div>
                        <div class="metric-value" id="currentStreak">0</div>
                        <div class="metric-label">Days Active</div>
                    </div>
                </div>
            </div>
        </div>
        <!-- NEW TRADE TAB -->
        <div class="tab-content" id="new-trade">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div>
                            <div class="card-title">New Trade</div>
                            <div class="card-subtitle">Capture execution details with structured notes</div>
                        </div>
                    </div>
                    <form id="tradeForm">
                        <div class="form-section">
                            <div class="form-section-title">Core trade</div>
                            <div class="form-group">
                                <label class="form-label">Date & Time</label>
                                <input type="datetime-local" class="form-input" id="tradeDateTime" required>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Symbol</label>
                                    <select class="form-select" id="tradeSymbol" required>
                                        <option value="NQ">NQ (E-mini Nasdaq-100)</option>
                                        <option value="ES">ES (E-mini S&P 500)</option>
                                        <option value="MNQ">MNQ (Micro E-mini Nasdaq-100)</option>
                                        <option value="MES">MES (Micro E-mini S&P 500)</option>
                                        <option value="GC">GC (Gold)</option>
                                        <option value="MGC">MGC (Micro Gold)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Direction</label>
                                    <select class="form-select" id="tradeDirection" required>
                                        <option value="long">Long</option>
                                        <option value="short">Short</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Entry Price</label>
                                    <input type="number" step="0.01" class="form-input" id="tradeEntry" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Exit Price</label>
                                    <input type="number" step="0.01" class="form-input" id="tradeExit" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Shares/Contracts</label>
                                    <input type="number" class="form-input" id="tradeQuantity" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">P&L</label>
                                    <input type="number" step="0.01" class="form-input" id="tradePnL" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">Risk</div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Stop Loss</label>
                                    <input type="number" step="0.01" class="form-input" id="tradeStopLoss">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Take Profit</label>
                                    <input type="number" step="0.01" class="form-input" id="tradeTakeProfit">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Setup/Strategy</label>
                                <select class="form-select" id="tradeSetup">
                                    <option value="breakout">Breakout</option>
                                    <option value="pullback">Pullback</option>
                                    <option value="reversal">Reversal</option>
                                    <option value="momentum">Momentum</option>
                                    <option value="scalp">Scalp</option>
                                    <option value="swing">Swing</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Timeframe</label>
                                <select class="form-select" id="tradeTimeframe">
                                    <option value="1m">1 Minute</option>
                                    <option value="5m">5 Minutes</option>
                                    <option value="15m">15 Minutes</option>
                                    <option value="30m">30 Minutes</option>
                                    <option value="1h">1 Hour</option>
                                    <option value="4h">4 Hours</option>
                                    <option value="1d">Daily</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Followed Strategy Plan?</label>
                                <select class="form-select" id="tradeFollowedPlan">
                                    <option value="yes">Yes - Followed Plan</option>
                                    <option value="no">No - Deviation from Plan</option>
                                </select>
                            </div>

                            <div class="form-group" id="deviationReasonGroup" style="display: none;">
                                <label class="form-label">Reason for Deviation</label>
                                <textarea class="form-textarea" id="tradeDeviationReason" placeholder="Why didn't you follow your strategy?"></textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">Plan & notes</div>
                            <div class="form-group">
                                <label class="form-label">Trade Notes</label>
                                <textarea class="form-textarea" id="tradeNotes" placeholder="What was your reasoning? What did you see?"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Mistakes Made</label>
                                <textarea class="form-textarea" id="tradeMistakes" placeholder="What could you have done better?"></textarea>
                            </div>
                        </div>

                        <div class="form-section" id="strategyTemplateSection">
                            <div class="form-section-title">Strategy Template</div>
                            <div class="template-preview">
                                <div class="template-block">
                                    <div class="template-label">Checklist</div>
                                    <ul class="template-checklist" id="strategyTemplateChecklist">
                                        <li class="template-empty">Select a setup to load its checklist.</li>
                                    </ul>
                                </div>
                                <div class="template-block">
                                    <div class="template-label">Notes Template</div>
                                    <textarea class="form-textarea" id="strategyTemplateNotes" readonly placeholder="Template notes will appear here."></textarea>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary btn-small" onclick="applyTemplateToNotes()">Apply template to trade notes</button>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">Psychology</div>
                            <div class="form-group">
                                <label class="form-label">Emotional State</label>
                                <div class="emotion-grid">
                                    <button type="button" class="btn btn-secondary emotion-pill" data-emotion="confident" onclick="selectEmotion(this)">üòé Confident</button>
                                    <button type="button" class="btn btn-secondary emotion-pill" data-emotion="calm" onclick="selectEmotion(this)">üòå Calm</button>
                                    <button type="button" class="btn btn-secondary emotion-pill" data-emotion="anxious" onclick="selectEmotion(this)">üò∞ Anxious</button>
                                    <button type="button" class="btn btn-secondary emotion-pill" data-emotion="fomo" onclick="selectEmotion(this)">üò§ FOMO</button>
                                    <button type="button" class="btn btn-secondary emotion-pill" data-emotion="revenge" onclick="selectEmotion(this)">üò° Revenge</button>
                                    <button type="button" class="btn btn-secondary emotion-pill" data-emotion="disciplined" onclick="selectEmotion(this)">üéØ Disciplined</button>
                                </div>
                                <input type="hidden" id="tradeEmotion">
                            </div>
                        </div>

                        <div class="form-section">
                            <div class="form-section-title">Attachments</div>
                            <div class="form-group">
                                <label class="form-label">Trade Screenshots</label>
                                <input type="file" id="tradeImages" multiple accept="image/*" style="display: none;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('tradeImages').click()">
                                    üì∑ Upload Screenshots
                                </button>
                                <div id="tradeImagesPreview" class="image-preview-grid"></div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                            üíæ Save Trade
                        </button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Pre-Trade Checklist</div>
                    </div>
                    <div id="preTradeChecklist">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="checklist-item">
                                <span>Market conditions analyzed</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="checklist-item">
                                <span>Setup matches strategy</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="checklist-item">
                                <span>Risk/reward ratio acceptable (min 1:2)</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="checklist-item">
                                <span>Position size calculated</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="checklist-item">
                                <span>Stop loss and take profit set</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="checklist-item">
                                <span>Not revenge trading</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="checklist-item">
                                <span>Daily loss limit not exceeded</span>
                            </label>
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" class="checklist-item">
                                <span>Emotionally stable</span>
                            </label>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                        <div class="card-title" style="margin-bottom: 1rem;">Quick Stats</div>
                        <div class="metric-card">
                            <div class="metric-label">Risk/Reward Ratio</div>
                            <div class="metric-value" id="quickRRRatio">0:0</div>
                        </div>
                        <div class="metric-card" style="margin-top: 1rem;">
                            <div class="metric-label">Position Size Recommendation</div>
                            <div class="metric-value" id="quickPositionSize">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- JOURNAL TAB -->
        <div class="tab-content" id="journal">
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="filter-toolbar">
                    <div class="filter-toolbar-row">
                        <select class="form-select" id="filterSymbol" style="max-width: 200px;">
                            <option value="">All Symbols</option>
                        </select>
                        <select class="form-select" id="filterSetup" style="max-width: 200px;">
                            <option value="">All Setups</option>
                            <option value="breakout">Breakout</option>
                            <option value="pullback">Pullback</option>
                            <option value="reversal">Reversal</option>
                            <option value="momentum">Momentum</option>
                            <option value="scalp">Scalp</option>
                            <option value="swing">Swing</option>
                        </select>
                        <select class="form-select" id="filterResult" style="max-width: 200px;">
                            <option value="">All Results</option>
                            <option value="win">Wins Only</option>
                            <option value="loss">Losses Only</option>
                        </select>
                        <select class="form-select" id="filterCompliance" style="max-width: 200px;">
                            <option value="">All Trades</option>
                            <option value="yes">Followed Strategy</option>
                            <option value="no">Deviated from Strategy</option>
                        </select>
                    </div>
                    <div class="filter-toolbar-row">
                        <button class="btn btn-primary btn-small" onclick="applyFilters()">Apply Filters</button>
                        <button class="btn btn-secondary btn-small" onclick="clearFilters()">Clear</button>
                        <div class="saved-views">
                            <select class="form-select" id="savedViewsSelect">
                                <option value="">Saved views</option>
                            </select>
                            <button class="btn btn-ghost btn-small" onclick="saveCurrentView()">Save View</button>
                            <button class="btn btn-secondary btn-small" onclick="updateCurrentView()">Update</button>
                            <button class="btn btn-danger btn-small" onclick="deleteCurrentView()">Delete</button>
                        </div>
                        <div class="applied-filters">Tip: combine filters to pinpoint your highest edge setups.</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="table-container">
                    <table class="journal-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Direction</th>
                                <th>Entry</th>
                                <th>Exit</th>
                                <th>Qty</th>
                                <th>P&L</th>
                                <th>Setup</th>
                                <th>Strategy</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="journalTable">
                            <tr>
                                <td colspan="10">
                                    <div class="empty-state">
                                        <span>üìì</span>
                                        <div>No trades recorded yet. Add your first trade!</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- DATA ANALYSIS TAB -->
        <div class="tab-content" id="data-analysis">
            <div class="analysis-header">
                <h2>Reports Hub</h2>
                <div style="color: var(--text-secondary); font-size: 0.9rem;">
                    TradeZella-style report cards and deep dives across edge, habits, and time.
                </div>
            </div>

            <div class="report-grid">
                <a class="report-card" href="#report-best-worst">
                    <div class="report-title">Best / Worst Days</div>
                    <div class="report-metric" id="reportBestDay">$0.00</div>
                    <div class="report-sub" id="reportBestDayMeta">No data yet</div>
                </a>
                <a class="report-card" href="#report-top-setups">
                    <div class="report-title">Top Setups</div>
                    <div class="report-metric" id="reportTopSetup">--</div>
                    <div class="report-sub" id="reportTopSetupMeta">Awaiting trades</div>
                </a>
                <a class="report-card" href="#report-bad-habits">
                    <div class="report-title">Bad Habits</div>
                    <div class="report-metric" id="reportCompliance">0%</div>
                    <div class="report-sub" id="reportComplianceMeta">0 off-plan trades</div>
                </a>
                <a class="report-card" href="#report-expectancy">
                    <div class="report-title">Expectancy</div>
                    <div class="report-metric" id="reportExpectancy">$0.00</div>
                    <div class="report-sub">Per-trade edge</div>
                </a>
                <a class="report-card" href="#report-daytime">
                    <div class="report-title">Day & Time</div>
                    <div class="report-metric" id="reportDayTime">--</div>
                    <div class="report-sub">Best session snapshot</div>
                </a>
            </div>

            <!-- Overall Summary -->
            <div class="analysis-summary">
                <div class="summary-stat">
                    <div class="summary-stat-value positive" id="analysisWins">0</div>
                    <div class="summary-stat-label">Total Wins</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value negative" id="analysisLosses">0</div>
                    <div class="summary-stat-label">Total Losses</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="analysisTotalTrades">0</div>
                    <div class="summary-stat-label">Total Trades</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="analysisWinRate">0%</div>
                    <div class="summary-stat-label">Win Rate</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="analysisAvgRR">0:0</div>
                    <div class="summary-stat-label">Avg R:R</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value positive" id="analysisTotalPnL">$0</div>
                    <div class="summary-stat-label">Total P&L</div>
                </div>
            </div>

            <div class="grid-2 report-section" id="report-best-worst">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Best Day Report</div>
                    </div>
                    <div class="report-highlight">
                        <div class="metric-value positive" id="reportBestDayValue">$0.00</div>
                        <div class="metric-label" id="reportBestDayDate">No data yet</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Worst Day Report</div>
                    </div>
                    <div class="report-highlight">
                        <div class="metric-value negative" id="reportWorstDayValue">$0.00</div>
                        <div class="metric-label" id="reportWorstDayDate">No data yet</div>
                    </div>
                </div>
            </div>

            <div class="card report-section" id="report-top-setups" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">Top Setups Report</div>
                    <div class="card-subtitle">Best performing setups across all trades</div>
                </div>
                <div id="reportTopSetupsList" class="report-list"></div>
            </div>

            <div class="card report-section" id="report-bad-habits" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">Bad Habits Report</div>
                    <div class="card-subtitle">Plan deviations, rule breaks, and their cost</div>
                </div>
                <div class="grid-2">
                    <div class="metric-card">
                        <div class="metric-label">Off-plan Trades</div>
                        <div class="metric-value" id="reportOffPlanTrades">0</div>
                        <div class="metric-change" id="reportOffPlanRate">0% of trades</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Rule Break Cost</div>
                        <div class="metric-value" id="reportViolationCost">$0.00</div>
                        <div class="metric-change">Tracked P/L impact</div>
                    </div>
                </div>
                <div class="report-callout" id="reportBadHabitCallout">No habit data yet.</div>
            </div>

            <div class="card report-section" id="report-expectancy" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">Expectancy Report</div>
                    <div class="card-subtitle">Measure edge per trade and per setup</div>
                </div>
                <div class="grid-2">
                    <div class="metric-card">
                        <div class="metric-label">Expectancy / Trade</div>
                        <div class="metric-value" id="reportExpectancyValue">$0.00</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Avg R Multiple</div>
                        <div class="metric-value" id="reportExpectancyR">0.00</div>
                    </div>
                </div>
            </div>

            <div class="report-section" id="report-daytime">
            <!-- Day of Week Analysis -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">Performance by Day of Week</div>
                </div>
                <div id="dayOfWeekAnalysis"></div>
            </div>

            <!-- Long vs Short Analysis -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Long vs Short Performance</div>
                    </div>
                    <div id="longShortAnalysis"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Long vs Short Distribution</div>
                    </div>
                    <div class="pie-chart-container" id="longShortPieChart">
                        <div style="color: var(--text-secondary);">No data yet</div>
                    </div>
                </div>
            </div>

            <!-- Contract Size Analysis -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">Performance by Contract/Share Size</div>
                </div>
                <div id="contractAnalysis"></div>
            </div>

            <!-- Session Analysis -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">Performance by Trading Session</div>
                    <button class="btn btn-small btn-secondary" onclick="openSessionConfig()">‚öôÔ∏è Configure Sessions</button>
                </div>
                <div id="sessionAnalysis">
                    <div style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                        Configure your trading sessions in settings to see session analysis
                    </div>
                </div>
            </div>

            <!-- Setup Performance Detailed -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">Detailed Setup Analysis</div>
                </div>
                <div id="setupDetailedAnalysis"></div>
            </div>

            <!-- Strategy Compliance Analysis -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">Strategy Compliance Analysis</div>
                </div>
                <div class="grid-2">
                    <div>
                        <div class="metric-card">
                            <div class="metric-label">Trades Following Strategy</div>
                            <div class="metric-value positive" id="complianceFollowed">0</div>
                            <div class="metric-change positive" id="complianceFollowedWR">0% Win Rate</div>
                        </div>
                    </div>
                    <div>
                        <div class="metric-card">
                            <div class="metric-label">Trades Deviating from Strategy</div>
                            <div class="metric-value negative" id="complianceDeviated">0</div>
                            <div class="metric-change negative" id="complianceDeviatedWR">0% Win Rate</div>
                        </div>
                    </div>
                </div>
                <div style="margin-top: 1.5rem;">
                    <div class="comparison-row">
                        <div class="comparison-label">Compliance Impact</div>
                        <div class="comparison-bar">
                            <div class="comparison-bar-fill" id="complianceImpactBar" style="width: 0%"></div>
                        </div>
                        <div class="comparison-value" id="complianceImpactValue">0%</div>
                    </div>
                </div>
            </div>

            <!-- Timeframe Analysis -->
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">Performance by Timeframe</div>
                </div>
                <div id="timeframeAnalysis"></div>
            </div>

            <!-- Symbol Performance Top/Bottom -->
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Top 5 Performing Symbols</div>
                    </div>
                    <div id="topSymbols"></div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Bottom 5 Performing Symbols</div>
                    </div>
                    <div id="bottomSymbols"></div>
                </div>
            </div>

            <!-- Win/Loss Streaks -->
            <div class="grid-2" style="margin-top: 1.5rem;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Longest Win Streak</div>
                    </div>
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üèÜ</div>
                        <div class="metric-value positive" id="longestWinStreak">0</div>
                        <div class="metric-label">Consecutive Wins</div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Longest Loss Streak</div>
                    </div>
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìâ</div>
                        <div class="metric-value negative" id="longestLossStreak">0</div>
                        <div class="metric-label">Consecutive Losses</div>
                    </div>
                </div>
            </div>
            </div>
        </div>
        <!-- ANALYTICS TAB -->
        <div class="tab-content" id="analytics">
            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Performance by Setup</div>
                    </div>
                    <div class="chart-container">
                        <div class="modern-chart" id="setupPerformanceChart"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Performance by Symbol</div>
                    </div>
                    <div class="chart-container">
                        <div class="modern-chart" id="symbolPerformanceChart"></div>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: space-around; margin: 2rem 0;">
                <div style="text-align: center;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; border: 8px solid var(--accent-primary); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <div style="font-size: 1.5rem; font-weight: bold;" id="analyticsWinRate">0%</div>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Win Rate</div>
                </div>
                <div style="text-align: center;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; border: 8px solid var(--accent-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <div style="font-size: 1.5rem; font-weight: bold;" id="analyticsProfitFactor">0.0</div>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Profit Factor</div>
                </div>
                <div style="text-align: center;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; border: 8px solid var(--accent-primary); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <div style="font-size: 1.5rem; font-weight: bold;" id="analyticsAvgRR">0:0</div>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Avg R:R</div>
                </div>
                <div style="text-align: center;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; border: 8px solid var(--accent-secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 1rem;">
                        <div style="font-size: 1.5rem; font-weight: bold;" id="analyticsExpectancy">$0</div>
                    </div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Expectancy</div>
                </div>
            </div>

            <div class="grid-3">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Win/Loss Distribution</div>
                    </div>
                    <div id="winLossDistribution">
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <div style="flex: 1; text-align: center;">
                                <div style="font-size: 2rem; color: var(--accent-primary);">0</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Wins</div>
                            </div>
                            <div style="flex: 1; text-align: center;">
                                <div style="font-size: 2rem; color: var(--accent-danger);">0</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">Losses</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Best Trading Day</div>
                    </div>
                    <div style="text-align: center; padding: 2rem;">
                        <div class="metric-value positive" id="bestDay">$0.00</div>
                        <div class="metric-label" id="bestDayDate">-</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Worst Trading Day</div>
                    </div>
                    <div style="text-align: center; padding: 2rem;">
                        <div class="metric-value negative" id="worstDay">$0.00</div>
                        <div class="metric-label" id="worstDayDate">-</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">Trading Heatmap - Time of Day Performance</div>
                </div>
                <div id="timeHeatmap" class="time-heatmap"></div>
                <div class="time-heatmap-labels">
                    <span>12 AM</span>
                    <span>6 AM</span>
                    <span>12 PM</span>
                    <span>6 PM</span>
                    <span>11 PM</span>
                </div>
            </div>

            <div class="grid-2" style="margin-top: 1.5rem;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Monthly P/L Heatmap</div>
                    </div>
                    <div id="monthlyHeatmap" class="monthly-heatmap-wrapper"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Strategy Performance</div>
                    </div>
                    <div class="table-container">
                        <table class="strategy-table">
                            <thead>
                                <tr>
                                    <th><button class="table-sort" data-sort="setup" onclick="sortStrategyTable('setup')">Setup</button></th>
                                    <th><button class="table-sort" data-sort="trades" onclick="sortStrategyTable('trades')">Trades</button></th>
                                    <th><button class="table-sort" data-sort="winRate" onclick="sortStrategyTable('winRate')">Win Rate</button></th>
                                    <th><button class="table-sort" data-sort="pnl" onclick="sortStrategyTable('pnl')">Net P&L</button></th>
                                    <th><button class="table-sort" data-sort="avgWin" onclick="sortStrategyTable('avgWin')">Avg Win</button></th>
                                    <th><button class="table-sort" data-sort="avgLoss" onclick="sortStrategyTable('avgLoss')">Avg Loss</button></th>
                                </tr>
                            </thead>
                            <tbody id="strategyPerformanceTable">
                                <tr>
                                    <td colspan="6">
                                        <div class="empty-state">
                                            <span>üìä</span>
                                            <div>No strategy data yet</div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Performance by Emotion</div>
                    </div>
                    <div id="emotionAnalysis" style="margin-top: 1rem;"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Consecutive Wins/Losses</div>
                    </div>
                    <div style="padding: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Longest Win Streak</div>
                            <div class="metric-value positive" id="longestWinStreakAnalytics">0</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">Longest Loss Streak</div>
                            <div class="metric-value negative" id="longestLossStreakAnalytics">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CALENDAR TAB -->
        <div class="tab-content" id="calendar">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Trading Calendar</div>
                    <div>
                        <button class="btn btn-small btn-secondary" onclick="previousMonth()">‚Üê Previous</button>
                        <span id="currentMonth" style="margin: 0 1rem;"></span>
                        <button class="btn btn-small btn-secondary" onclick="nextMonth()">Next ‚Üí</button>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-secondary);">
                    <div style="text-align: center;">Sun</div>
                    <div style="text-align: center;">Mon</div>
                    <div style="text-align: center;">Tue</div>
                    <div style="text-align: center;">Wed</div>
                    <div style="text-align: center;">Thu</div>
                    <div style="text-align: center;">Fri</div>
                    <div style="text-align: center;">Sat</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 0.5rem;" id="calendarGrid"></div>
            </div>

            <div class="grid-2" style="margin-top: 1.5rem;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Monthly Summary</div>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-label">Total P&L</div>
                            <div class="metric-value" id="monthlyPnL">$0.00</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Trading Days</div>
                            <div class="metric-value" id="monthlyTradingDays">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Total Trades</div>
                            <div class="metric-value" id="monthlyTrades">0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Win Rate</div>
                            <div class="metric-value" id="monthlyWinRate">0%</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Daily Notes</div>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;" id="dailyNotesList">
                        <div style="color: var(--text-secondary); text-align: center; padding: 2rem;">
                            Select a day to view or add notes
                        </div>
                    </div>
                    <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="addDailyNote()">
                        + Add Note
                    </button>
                </div>
            </div>
        </div>

        <!-- PLAYBOOK TAB -->
        <div class="tab-content" id="playbook">
            <div class="card playbook-hero" style="margin-bottom: 1.5rem;">
                <div class="playbook-hero-content">
                    <div>
                        <div class="card-title">Playbook & Strategy Library</div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                            Organize setups, checklist templates, and performance insights in one workspace.
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="openAddStrategyModal()">+ Add Strategy</button>
                </div>
            </div>

            <div class="playbook-layout">
                <div class="playbook-list">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Strategy Library</div>
                            <div class="card-subtitle">Select a setup to review performance and templates.</div>
                        </div>
                        <div id="strategiesContainer" class="playbook-cards">
                            <!-- Strategies will be rendered here -->
                        </div>
                    </div>
                </div>
                <div class="playbook-detail">
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Setup Performance Snapshot</div>
                        </div>
                        <div id="playbookPerformanceSnapshot" class="playbook-snapshot">
                            <div class="empty-state">
                                <span>üìà</span>
                                <div>Track trades to populate setup performance insights.</div>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="margin-top: 1.5rem;">
                        <div class="card-header">
                            <div class="card-title">Template Guidance</div>
                            <div class="card-subtitle">Checklist and notes templates auto-load when logging trades.</div>
                        </div>
                        <ul class="template-guidance">
                            <li>Define checklist items for your setup execution steps.</li>
                            <li>Add a notes template to keep reviews consistent.</li>
                            <li>Apply templates directly into the trade entry workflow.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- RULES TAB -->
        <div class="tab-content" id="rules">
            <div class="card" style="margin-bottom: 1.5rem;">
                <div class="card-header">
                    <div>
                        <div class="card-title">Rules & Notebook</div>
                        <div class="card-subtitle">Codify risk management, mental game, and review notes.</div>
                    </div>
                    <button class="btn btn-primary btn-small" onclick="openEditRulesModal()">‚úèÔ∏è Edit Rules</button>
                </div>
                <div class="grid-2" id="tradingRulesDisplay">
                    <!-- Rules will be rendered here -->
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <div class="card-title">Notebook Prompts</div>
                    <div class="card-subtitle">Use these prompts during reviews to build discipline.</div>
                </div>
                <div class="notebook-prompts">
                    <div class="prompt-card">What did I execute perfectly today?</div>
                    <div class="prompt-card">Where did I deviate, and why?</div>
                    <div class="prompt-card">What rule protected my capital most?</div>
                    <div class="prompt-card">What will I repeat or avoid tomorrow?</div>
                </div>
            </div>
        </div>

    <!-- Add/Edit Strategy Modal -->
    <div class="modal" id="strategyModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="strategyModalTitle">Add New Strategy</h2>
                <button class="modal-close" onclick="closeModal('strategyModal')">√ó</button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Strategy Name *</label>
                    <input type="text" class="form-input" id="strategyName" placeholder="e.g., Breakout Strategy">
                </div>

                <div class="form-group">
                    <label class="form-label">Entry Criteria *</label>
                    <div id="entryCriteriaList"></div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addCriteriaItem('entry')" style="margin-top: 0.5rem;">+ Add Entry Criterion</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Exit Criteria *</label>
                    <div id="exitCriteriaList"></div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addCriteriaItem('exit')" style="margin-top: 0.5rem;">+ Add Exit Criterion</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Best Timeframes</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 0.5rem;" id="timeframeSelector">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                            <input type="checkbox" value="1m"> 1m
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                            <input type="checkbox" value="5m"> 5m
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                            <input type="checkbox" value="15m"> 15m
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                            <input type="checkbox" value="30m"> 30m
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                            <input type="checkbox" value="1h"> 1h
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                            <input type="checkbox" value="4h"> 4h
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem; background: var(--bg-tertiary); border-radius: 4px;">
                            <input type="checkbox" value="1d"> 1d
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Checklist Template</label>
                    <textarea class="form-textarea" id="strategyChecklistTemplate" placeholder="One checklist item per line..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes Template</label>
                    <textarea class="form-textarea" id="strategyNotesTemplate" placeholder="Template text for trade reviews..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Additional Notes (Optional)</label>
                    <textarea class="form-textarea" id="strategyNotes" placeholder="Any additional information about this strategy..."></textarea>
                </div>

                <input type="hidden" id="editingStrategyId">
                <button class="btn btn-primary" style="width: 100%;" onclick="saveStrategy()">Save Strategy</button>
            </div>
        </div>
    </div>

    <!-- Edit Trading Rules Modal -->
    <div class="modal" id="editRulesModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Edit Trading Rules & Principles</h2>
                <button class="modal-close" onclick="closeModal('editRulesModal')">√ó</button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Risk Management Rules</label>
                    <div id="riskManagementList"></div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addRuleItem('risk')" style="margin-top: 0.5rem;">+ Add Rule</button>
                </div>

                <div class="form-group">
                    <label class="form-label">Mental Game / Psychology Rules</label>
                    <div id="mentalGameList"></div>
                    <button type="button" class="btn btn-secondary btn-small" onclick="addRuleItem('mental')" style="margin-top: 0.5rem;">+ Add Rule</button>
                </div>

                <button class="btn btn-primary" style="width: 100%;" onclick="saveTradingRules()">Save Rules</button>
            </div>
        </div>
    </div>

        <!-- SETTINGS TAB -->
        <div class="tab-content" id="settings">
            <div class="settings-grid">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Account Settings</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Starting Capital</label>
                        <input type="number" class="form-input" id="settingStartingCapital" placeholder="10000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Risk Per Trade (%)</label>
                        <input type="number" class="form-input" id="settingRiskPerTrade" placeholder="1" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Daily Loss Limit (%)</label>
                        <input type="number" class="form-input" id="settingDailyLossLimit" placeholder="3" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Daily Profit Goal ($)</label>
                        <input type="number" class="form-input" id="settingDailyGoal" placeholder="500">
                    </div>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Trading Goals</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Weekly Profit Goal ($)</label>
                        <input type="number" class="form-input" id="settingWeeklyGoal" placeholder="2500">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Monthly Profit Goal ($)</label>
                        <input type="number" class="form-input" id="settingMonthlyGoal" placeholder="10000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Target Win Rate (%)</label>
                        <input type="number" class="form-input" id="settingTargetWinRate" placeholder="60">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Trades Per Day</label>
                        <input type="number" class="form-input" id="settingMaxTrades" placeholder="5">
                    </div>
                </div>
            </div>

            <!-- Trading Sessions Configuration -->
            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">Trading Sessions Configuration</div>
                    <button class="btn btn-primary btn-small" onclick="addTradingSession()">+ Add Session</button>
                </div>
                <div id="sessionsContainer">
                    <div class="session-item">
                        <input type="text" class="form-input" placeholder="Session Name" value="Pre-Market" id="session0Name">
                        <input type="time" class="form-input" value="04:00" id="session0Start">
                        <input type="time" class="form-input" value="09:30" id="session0End">
                        <button class="btn btn-danger btn-small" onclick="removeSession(0)">Remove</button>
                    </div>
                    <div class="session-item">
                        <input type="text" class="form-input" placeholder="Session Name" value="Market Open" id="session1Name">
                        <input type="time" class="form-input" value="09:30" id="session1Start">
                        <input type="time" class="form-input" value="11:00" id="session1End">
                        <button class="btn btn-danger btn-small" onclick="removeSession(1)">Remove</button>
                    </div>
                    <div class="session-item">
                        <input type="text" class="form-input" placeholder="Session Name" value="Mid-Day" id="session2Name">
                        <input type="time" class="form-input" value="11:00" id="session2Start">
                        <input type="time" class="form-input" value="14:00" id="session2End">
                        <button class="btn btn-danger btn-small" onclick="removeSession(2)">Remove</button>
                    </div>
                    <div class="session-item">
                        <input type="text" class="form-input" placeholder="Session Name" value="Power Hour" id="session3Name">
                        <input type="time" class="form-input" value="14:00" id="session3Start">
                        <input type="time" class="form-input" value="16:00" id="session3End">
                        <button class="btn btn-danger btn-small" onclick="removeSession(3)">Remove</button>
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="saveSessions()">Save Sessions</button>
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">Data Management</div>
                </div>
                <div class="export-grid">
                    <div class="export-card">
                        <div class="export-title">Exports</div>
                        <div class="export-actions">
                            <button class="btn btn-primary" onclick="exportData()">üì• Export All Data (JSON)</button>
                            <button class="btn btn-primary" onclick="exportCSV()">üìä Export Trades (CSV)</button>
                            <button class="btn btn-secondary" onclick="exportEncryptedBackup()">üîê Encrypted Backup</button>
                        </div>
                    </div>
                    <div class="export-card">
                        <div class="export-title">Imports</div>
                        <div class="export-actions">
                            <button class="btn btn-secondary" onclick="importData()">üì§ Import JSON</button>
                            <button class="btn btn-secondary" onclick="importEncryptedBackup()">üîì Import Encrypted</button>
                        </div>
                    </div>
                    <div class="export-card">
                        <div class="export-title">Reports</div>
                        <div class="export-actions">
                            <button class="btn btn-ghost" onclick="openMonthlyReport()">üßæ Monthly Report</button>
                        </div>
                    </div>
                </div>
                <div class="danger-zone">
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                    <div class="help-text">This permanently removes all stored trades, notes, strategies, and settings.</div>
                </div>
                <input type="file" id="importFile" accept=".json" style="display: none;">
                <input type="file" id="encryptedImportFile" accept=".json" style="display: none;">
            </div>

            <div class="card" style="margin-top: 1.5rem;">
                <div class="card-header">
                    <div class="card-title">About</div>
                </div>
                <div style="color: var(--text-secondary); line-height: 1.8;">
                    <p><strong>Trading Journal Pro v2.0</strong></p>
                    <p>A comprehensive daytrading journal suite for serious traders.</p>
                    <p>Features include trade logging, analytics, calendar tracking, playbook management, multi-account support, and comprehensive data analysis.</p>
                    <p style="margin-top: 1rem;">All data is stored locally in your browser.</p>
                </div>
            </div>
        </div>
            </main>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>
    <div class="print-report" id="printReport"></div>

    <!-- Trade Detail Modal -->
    <div class="modal drawer-modal" id="tradeDetailModal">
        <div class="modal-content drawer-content">
            <div class="modal-header">
                <h2>Trade Details</h2>
                <button class="modal-close" onclick="closeModal('tradeDetailModal')">√ó</button>
            </div>
            <div id="tradeDetailContent"></div>
        </div>
    </div>

    <!-- Add Account Modal -->
    <div class="modal" id="addAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Account</h2>
                <button class="modal-close" onclick="closeModal('addAccountModal')">√ó</button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-input" id="newAccountName" placeholder="e.g., Options Account, Futures Account">
                </div>
                <div class="form-group">
                    <label class="form-label">Account Type (Optional)</label>
                    <select class="form-select" id="newAccountType">
                        <option value="stocks">Stocks</option>
                        <option value="options">Options</option>
                        <option value="futures">Futures</option>
                        <option value="forex">Forex</option>
                        <option value="crypto">Crypto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Copy Strategies From</label>
                    <select class="form-select" id="copyStrategiesFrom">
                        <option value="">Don't copy strategies</option>
                    </select>
                    <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                        üí° Copy existing strategies to this new account to get started faster
                    </div>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="saveNewAccount()">Create Account</button>
            </div>
        </div>
    </div>

    <!-- Edit Account Modal -->
    <div class="modal" id="editAccountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Account</h2>
                <button class="modal-close" onclick="closeModal('editAccountModal')">√ó</button>
            </div>
            <div>
                <div class="form-group">
                    <label class="form-label">Account Name</label>
                    <input type="text" class="form-input" id="editAccountName" placeholder="e.g., Main Account">
                </div>
                <div class="form-group">
                    <label class="form-label">Account Type (Optional)</label>
                    <select class="form-select" id="editAccountType">
                        <option value="stocks">Stocks</option>
                        <option value="options">Options</option>
                        <option value="futures">Futures</option>
                        <option value="forex">Forex</option>
                        <option value="crypto">Crypto</option>
                    </select>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="saveEditAccount()">Save Changes</button>
            </div>
        </div>
    </div>
    <!-- Session Config Modal -->
    <div class="modal" id="sessionConfigModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Configure Trading Sessions</h2>
                <button class="modal-close" onclick="closeModal('sessionConfigModal')">√ó</button>
            </div>
            <div style="color: var(--text-secondary); margin-bottom: 1rem;">
                Configure your trading sessions in the Settings tab to analyze performance by time of day.
            </div>
            <button class="btn btn-primary" onclick="closeModal('sessionConfigModal'); switchTab('settings')">Go to Settings</button>
        </div>
    </div>
    <script src="db.js"></script>
    <script src="analytics.js"></script>
    <script src="reports.js"></script>
    <script>
        // ========== DATA STORAGE ==========
        let currentAccount = localStorage.getItem('currentAccount') || 'default';
        let accounts = JSON.parse(localStorage.getItem('accounts')) || {
            'default': { name: 'Main Account', type: 'stocks' }
        };
        
        let allTrades = JSON.parse(localStorage.getItem('allTrades')) || { 'default': [] };
        let trades = allTrades[currentAccount] || [];
        
        let settings = JSON.parse(localStorage.getItem('settings')) || {
            startingCapital: 10000,
            riskPerTrade: 1,
            dailyLossLimit: 3,
            dailyGoal: 500,
            weeklyGoal: 2500,
            monthlyGoal: 10000,
            targetWinRate: 60,
            maxTrades: 5
        };

        let tradingSessions = JSON.parse(localStorage.getItem('tradingSessions')) || [
            { name: 'Pre-Market', start: '04:00', end: '09:30' },
            { name: 'Market Open', start: '09:30', end: '11:00' },
            { name: 'Mid-Day', start: '11:00', end: '14:00' },
            { name: 'Power Hour', start: '14:00', end: '16:00' }
        ];

        let dailyNotes = JSON.parse(localStorage.getItem('dailyNotes')) || {};
        let strategies = JSON.parse(localStorage.getItem('strategies')) || {};
        let tradingRules = JSON.parse(localStorage.getItem('tradingRules')) || {
            risk: [
                'Never risk more than 1% per trade',
                'Maximum 3 trades per day',
                'Daily loss limit: 3%',
                'Stop trading after 2 consecutive losses',
                'Position size based on stop distance'
            ],
            mental: [
                'No revenge trading',
                'Don\'t chase entries',
                'Take breaks between trades',
                'Accept losses as part of the game',
                'Focus on process, not outcomes'
            ]
        };

        let savedViews = [];
        let currentViewId = '';
        let isDbReady = false;
        let strategySort = { key: 'pnl', direction: 'desc' };
        let strategyPerformanceData = [];

        const futuresContractSpecs = {
            NQ: { pointValue: 20, tickSize: 0.25, tickValue: 5 },
            ES: { pointValue: 50, tickSize: 0.25, tickValue: 12.5 },
            MNQ: { pointValue: 2, tickSize: 0.25, tickValue: 0.5 },
            MES: { pointValue: 5, tickSize: 0.25, tickValue: 1.25 },
            GC: { pointValue: 100, tickSize: 0.1, tickValue: 10 },
            MGC: { pointValue: 10, tickSize: 0.1, tickValue: 1 }
        };

        // Initialize strategies for current account if needed
        if (!strategies[currentAccount]) {
            strategies[currentAccount] = [];
        }
        let currentCalendarDate = new Date();
        let currentPnLView = 'daily';
        let sessionCounter = 4;

        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async function() {
            initializeTheme();
            initializeTabs();
            initializeAccountSelector();
            initializeTradeForm();
            initializeSavedViews();
            await initializeStorage();
            loadSettings();
            loadSessions();
            updateDashboard();
            renderCalendar();
            renderJournal();
            renderAnalytics();
            renderDataAnalysis();
            setDefaultDateTime();
	    renderPlaybook();
	    renderTradingRules();
	    updateSetupDropdown();
        });

        // ========== THEME TOGGLE ==========
        function initializeTheme() {
            const savedTheme = localStorage.getItem('uiTheme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            applyTheme(theme);
        }

        function applyTheme(theme) {
            const body = document.body;
            body.classList.toggle('theme-dark', theme === 'dark');
            localStorage.setItem('uiTheme', theme);

            const toggleBtn = document.getElementById('themeToggle');
            if (toggleBtn) {
                toggleBtn.textContent = theme === 'dark' ? 'üåô Dark' : '‚òÄÔ∏è Light';
            }
        }

        function toggleTheme() {
            const isDark = document.body.classList.contains('theme-dark');
            applyTheme(isDark ? 'light' : 'dark');
        }

        // ========== TAB NAVIGATION ==========
        function initializeTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;
                    switchTab(tabName);
                });
            });
        }

        function switchTab(tabName) {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // Refresh data when switching tabs
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'analytics') renderAnalytics();
            if (tabName === 'data-analysis') renderDataAnalysis();
            if (tabName === 'calendar') renderCalendar();
            if (tabName === 'journal') renderJournal();
        }

        // ========== STORAGE & MIGRATION ==========
        async function initializeStorage() {
            try {
                await TradeJournalDB.openDB();
                isDbReady = true;
            } catch (error) {
                console.warn('IndexedDB unavailable, falling back to localStorage.', error);
                isDbReady = false;
                return;
            }

            const migrationDone = await TradeJournalDB.getSetting('migration_done');
            if (!migrationDone) {
                await migrateLocalStorageTrades();
                await TradeJournalDB.saveSetting('migration_done', true);
            }

            const storedSettings = await TradeJournalDB.getSetting('settings');
            if (storedSettings) {
                settings = storedSettings;
                localStorage.setItem('settings', JSON.stringify(settings));
            } else {
                await TradeJournalDB.saveSetting('settings', settings);
            }

            await loadTradesForAccount(currentAccount);
            await loadSavedViews();
        }

        async function migrateLocalStorageTrades() {
            const legacyTrades = JSON.parse(localStorage.getItem('allTrades')) || {};
            const tradesToImport = [];

            Object.entries(legacyTrades).forEach(([accountId, accountTrades]) => {
                (accountTrades || []).forEach(trade => {
                    tradesToImport.push({
                        ...trade,
                        account: trade.account || accountId,
                        images: []
                    });
                });
            });

            if (tradesToImport.length) {
                await TradeJournalDB.saveTradesBulk(tradesToImport);
            }
        }

        function stripTradeImages(trade) {
            const { images, ...rest } = trade;
            return { ...rest, images: [] };
        }

        async function loadTradesForAccount(accountId) {
            if (!isDbReady) {
                trades = allTrades[accountId] || [];
                return;
            }

            trades = await TradeJournalDB.getTradesByAccount(accountId);
            allTrades[accountId] = trades.map(stripTradeImages);
            localStorage.setItem('allTrades', JSON.stringify(allTrades));
        }

        async function loadSavedViews() {
            if (!isDbReady) return;
            currentViewId = '';
            savedViews = await TradeJournalDB.getViews(currentAccount);
            renderViewsDropdown();
        }

        async function deleteTradesForAccount(accountId) {
            if (!isDbReady) return;
            const accountTrades = await TradeJournalDB.getTradesByAccount(accountId);
            for (const trade of accountTrades) {
                await TradeJournalDB.deleteTrade(trade.id);
            }
        }

        // ========== ACCOUNT MANAGEMENT ==========
        function initializeAccountSelector() {
            const selector = document.getElementById('accountSelector');
            selector.innerHTML = '';
            
            Object.keys(accounts).forEach(accountId => {
                const option = document.createElement('option');
                option.value = accountId;
                option.textContent = accounts[accountId].name;
                if (accountId === currentAccount) option.selected = true;
                selector.appendChild(option);
            });
        }

        async function switchAccount() {
            currentAccount = document.getElementById('accountSelector').value;
            localStorage.setItem('currentAccount', currentAccount);
            
            await loadTradesForAccount(currentAccount);
            await loadSavedViews();
            
            // Refresh all displays
            updateDashboard();
            renderJournal();
            renderAnalytics();
            renderDataAnalysis();
            renderCalendar();
            renderPlaybook();
            updateSetupDropdown();
        }

        function addNewAccount() {
            // Populate the copy strategies dropdown
            const copyDropdown = document.getElementById('copyStrategiesFrom');
            copyDropdown.innerHTML = '<option value="">Don\'t copy strategies</option>';
            
            Object.entries(accounts).forEach(([accountId, accountData]) => {
                const strategyCount = strategies[accountId]?.length || 0;
                const label = strategyCount > 0 
                    ? `${accountData.name} (${strategyCount} strateg${strategyCount === 1 ? 'y' : 'ies'})`
                    : `${accountData.name} (No strategies)`;
                
                copyDropdown.innerHTML += `<option value="${accountId}">${label}</option>`;
            });
            
            document.getElementById('addAccountModal').classList.add('active');
        }

        function saveNewAccount() {
            const name = document.getElementById('newAccountName').value.trim();
            const type = document.getElementById('newAccountType').value;
            const copyFrom = document.getElementById('copyStrategiesFrom').value;
            
            if (!name) {
                alert('Please enter an account name');
                return;
            }
            
            const accountId = 'account_' + Date.now();
            accounts[accountId] = { name, type };
            allTrades[accountId] = [];
            
            // Copy strategies if selected
            if (copyFrom && strategies[copyFrom]) {
                const sourceStrategies = strategies[copyFrom];
                const copiedStrategies = sourceStrategies.map(strategy => ({
                    ...strategy,
                    id: 'strategy_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    createdAt: new Date().toISOString(),
                    copiedFrom: copyFrom
                }));
                
                strategies[accountId] = copiedStrategies;
                
                const copyCount = copiedStrategies.length;
                const sourceAccountName = accounts[copyFrom].name;
                
                localStorage.setItem('strategies', JSON.stringify(strategies));
                
                alert(`‚úÖ Account created successfully!\n\n${copyCount} strateg${copyCount === 1 ? 'y' : 'ies'} copied from "${sourceAccountName}"`);
            } else {
                strategies[accountId] = [];
                alert('‚úÖ Account created successfully!');
            }
            
            localStorage.setItem('accounts', JSON.stringify(accounts));
            localStorage.setItem('allTrades', JSON.stringify(allTrades));
            
            initializeAccountSelector();
            closeModal('addAccountModal');
            
            document.getElementById('newAccountName').value = '';
            document.getElementById('copyStrategiesFrom').value = '';
        }

        function editAccount() {
            if (currentAccount === 'default') {
                // Allow editing default account name
                document.getElementById('editAccountName').value = accounts[currentAccount].name;
                document.getElementById('editAccountType').value = accounts[currentAccount].type || 'stocks';
                document.getElementById('editAccountModal').classList.add('active');
                return;
            }

            const accountData = accounts[currentAccount];
            if (!accountData) {
                alert('Please select an account to edit');
                return;
            }

            document.getElementById('editAccountName').value = accountData.name;
            document.getElementById('editAccountType').value = accountData.type || 'stocks';
            document.getElementById('editAccountModal').classList.add('active');
        }

        function saveEditAccount() {
            const name = document.getElementById('editAccountName').value.trim();
            const type = document.getElementById('editAccountType').value;

            if (!name) {
                alert('Please enter an account name');
                return;
            }

            accounts[currentAccount].name = name;
            accounts[currentAccount].type = type;

            localStorage.setItem('accounts', JSON.stringify(accounts));

            initializeAccountSelector();
            closeModal('editAccountModal');
            alert('‚úÖ Account updated successfully!');
        }

        async function deleteAccount() {
            if (currentAccount === 'default') {
                alert('‚ùå Cannot delete the default account.\n\nYou can rename it using the Edit button.');
                return;
            }

            const accountData = accounts[currentAccount];
            if (!accountData) {
                alert('Please select an account to delete');
                return;
            }

            const tradeCount = allTrades[currentAccount]?.length || 0;
            
            let confirmMessage = `‚ö†Ô∏è Delete Account: "${accountData.name}"?\n\n`;
            if (tradeCount > 0) {
                confirmMessage += `This account has ${tradeCount} trade${tradeCount > 1 ? 's' : ''}.\n\n`;
                confirmMessage += `ALL trades in this account will be permanently deleted!\n\n`;
            }
            confirmMessage += `This action cannot be undone.\n\nAre you sure?`;

            if (!confirm(confirmMessage)) {
                return;
            }

            // Double confirmation for accounts with trades
            if (tradeCount > 0) {
                const finalConfirm = prompt(`Type the account name "${accountData.name}" to confirm deletion:`);
                if (finalConfirm !== accountData.name) {
                    alert('Deletion cancelled - name did not match.');
                    return;
                }
            }

            // Delete the account
            delete accounts[currentAccount];
            delete allTrades[currentAccount];
            await deleteTradesForAccount(currentAccount);

            // Switch to default account
            currentAccount = 'default';
            trades = allTrades[currentAccount] || [];

            // Save changes
            localStorage.setItem('accounts', JSON.stringify(accounts));
            localStorage.setItem('allTrades', JSON.stringify(allTrades));
            localStorage.setItem('currentAccount', currentAccount);

            // Refresh UI
            initializeAccountSelector();
            updateDashboard();
            renderJournal();
            renderAnalytics();
            renderDataAnalysis();
            renderCalendar();

            alert('‚úÖ Account deleted successfully.');
        }

        // ========== TRADE FORM ==========
        function initializeTradeForm() {
            // Auto-calculate P&L
            ['tradeEntry', 'tradeExit', 'tradeQuantity', 'tradeDirection', 'tradeSymbol'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', calculatePnL);
            });
            ['tradeDirection', 'tradeSymbol'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', calculatePnL);
            });

            // Show/hide deviation reason
            document.getElementById('tradeFollowedPlan').addEventListener('change', function() {
                const deviationGroup = document.getElementById('deviationReasonGroup');
                if (this.value === 'no') {
                    deviationGroup.style.display = 'block';
                } else {
                    deviationGroup.style.display = 'none';
                }
            });

            // Form submission
            document.getElementById('tradeForm').addEventListener('submit', saveTrade);

            // Image upload
            document.getElementById('tradeImages').addEventListener('change', previewImages);

            const setupSelect = document.getElementById('tradeSetup');
            if (setupSelect) setupSelect.addEventListener('change', updateStrategyTemplate);

            updateStrategyTemplate();
        }

        function setDefaultDateTime() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('tradeDateTime').value = now.toISOString().slice(0, 16);
        }

        function selectEmotion(btn) {
            document.querySelectorAll('[data-emotion]').forEach(b => {
                b.classList.remove('is-selected');
            });

            btn.classList.add('is-selected');
            
            document.getElementById('tradeEmotion').value = btn.dataset.emotion;
        }

        function calculatePnL() {
            const entry = parseFloat(document.getElementById('tradeEntry').value) || 0;
            const exit = parseFloat(document.getElementById('tradeExit').value) || 0;
            const quantity = parseFloat(document.getElementById('tradeQuantity').value) || 0;
            const direction = document.getElementById('tradeDirection').value;
            const symbol = document.getElementById('tradeSymbol').value;
            const contractSpecs = futuresContractSpecs[symbol] || { pointValue: 1, tickSize: 1, tickValue: 1 };
            const pointValue = contractSpecs.pointValue;

            let pnl = 0;
            if (direction === 'long') {
                pnl = (exit - entry) * pointValue * quantity;
            } else {
                pnl = (entry - exit) * pointValue * quantity;
            }

            document.getElementById('tradePnL').value = pnl.toFixed(2);

            // Calculate R:R ratio
            const stopLoss = parseFloat(document.getElementById('tradeStopLoss').value) || 0;
            const takeProfit = parseFloat(document.getElementById('tradeTakeProfit').value) || 0;

            if (entry && stopLoss && takeProfit) {
                const risk = Math.abs(entry - stopLoss);
                const reward = Math.abs(takeProfit - entry);
                const rrRatio = risk > 0 ? (reward / risk).toFixed(2) : 0;
                document.getElementById('quickRRRatio').textContent = `1:${rrRatio}`;
            }

            // Position size recommendation
            if (settings.startingCapital && settings.riskPerTrade && entry && stopLoss) {
                const risk = Math.abs(entry - stopLoss);
                const riskAmount = settings.startingCapital * (settings.riskPerTrade / 100);
                const positionSize = Math.floor(riskAmount / (risk * pointValue));
                document.getElementById('quickPositionSize').textContent = positionSize;
            }
        }

        function previewImages(e) {
            const preview = document.getElementById('tradeImagesPreview');
            preview.innerHTML = '';
            
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'image-preview-card';
                    div.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function updateStrategyTemplate() {
            const checklistEl = document.getElementById('strategyTemplateChecklist');
            const notesEl = document.getElementById('strategyTemplateNotes');
            const setupValue = document.getElementById('tradeSetup')?.value;
            if (!checklistEl || !notesEl || !setupValue) return;

            const accountStrategies = strategies[currentAccount] || [];
            const matched = accountStrategies.find(strategy => {
                const slug = strategy.name.toLowerCase().replace(/\s+/g, '-');
                return slug === setupValue;
            });

            if (!matched) {
                checklistEl.innerHTML = '<li class="template-empty">Select a setup to load its checklist.</li>';
                notesEl.value = '';
                return;
            }

            const checklistItems = matched.checklistTemplate || [];
            checklistEl.innerHTML = checklistItems.length
                ? checklistItems.map(item => `<li>${item}</li>`).join('')
                : '<li class="template-empty">No checklist template added.</li>';
            notesEl.value = matched.notesTemplate || '';
        }

        function applyTemplateToNotes() {
            const notesEl = document.getElementById('tradeNotes');
            const templateNotes = document.getElementById('strategyTemplateNotes');
            if (!notesEl || !templateNotes) return;
            if (!templateNotes.value.trim()) {
                showToast('No template notes available for this setup', 'warning');
                return;
            }
            notesEl.value = templateNotes.value.trim();
            showToast('Template applied to trade notes', 'success');
        }

        async function saveTrade(e) {
            e.preventDefault();

            const imageFiles = Array.from(document.getElementById('tradeImages').files || []);
            const images = imageFiles.map(file => ({
                name: file.name,
                type: file.type,
                blob: file
            }));

            const trade = {
                id: Date.now(),
                date: document.getElementById('tradeDateTime').value,
                symbol: document.getElementById('tradeSymbol').value,
                direction: document.getElementById('tradeDirection').value,
                entry: parseFloat(document.getElementById('tradeEntry').value),
                exit: parseFloat(document.getElementById('tradeExit').value),
                quantity: parseFloat(document.getElementById('tradeQuantity').value),
                pnl: parseFloat(document.getElementById('tradePnL').value),
                stopLoss: parseFloat(document.getElementById('tradeStopLoss').value) || null,
                takeProfit: parseFloat(document.getElementById('tradeTakeProfit').value) || null,
                setup: document.getElementById('tradeSetup').value,
                timeframe: document.getElementById('tradeTimeframe').value,
                followedPlan: document.getElementById('tradeFollowedPlan').value,
                deviationReason: document.getElementById('tradeDeviationReason').value || null,
                notes: document.getElementById('tradeNotes').value,
                mistakes: document.getElementById('tradeMistakes').value,
                emotion: document.getElementById('tradeEmotion').value,
                images,
                account: currentAccount
            };

            trades.push(trade);
            allTrades[currentAccount] = trades.map(stripTradeImages);
            localStorage.setItem('allTrades', JSON.stringify(allTrades));

            if (isDbReady) {
                await TradeJournalDB.saveTrade(trade);
            }

            showToast('Trade saved successfully', 'success');
            document.getElementById('tradeForm').reset();
            setDefaultDateTime();
            document.querySelectorAll('[data-emotion]').forEach(btn => {
                btn.classList.remove('is-selected');
            });
            document.getElementById('tradeImagesPreview').innerHTML = '';
            document.getElementById('deviationReasonGroup').style.display = 'none';
            updateStrategyTemplate();

            updateDashboard();
            renderJournal();
            renderAnalytics();
            renderDataAnalysis();
        }

        // ========== UTILITY FUNCTIONS ==========
        function formatCurrency(value) {
            const prefix = value >= 0 ? '+$' : '-$';
            return prefix + Math.abs(value).toFixed(2);
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            });
        }

        function formatDateTime(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if (!container) return;
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modal on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
    
        // ========== DASHBOARD FUNCTIONS ==========
        function updateDashboard() {
            const stats = calculateStats();

            // Header stats
            document.getElementById('headerDailyPnL').textContent = formatCurrency(stats.dailyPnL);
            document.getElementById('headerDailyPnL').className = `stat-value ${stats.dailyPnL >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('headerWeeklyPnL').textContent = formatCurrency(stats.weeklyPnL);
            document.getElementById('headerWeeklyPnL').className = `stat-value ${stats.weeklyPnL >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('headerWinRate').textContent = stats.winRate.toFixed(1) + '%';
            document.getElementById('headerTotalTrades').textContent = trades.length;

            // Dashboard metrics
            document.getElementById('totalPnL').textContent = formatCurrency(stats.totalPnL);
            document.getElementById('totalPnL').className = `metric-value ${stats.totalPnL >= 0 ? 'positive' : 'negative'}`;
            
            document.getElementById('winRate').textContent = stats.winRate.toFixed(1) + '%';
            document.getElementById('winRateProgress').style.width = stats.winRate + '%';
            
            document.getElementById('totalTrades').textContent = trades.length;
            document.getElementById('avgWin').textContent = formatCurrency(stats.avgWin);
            document.getElementById('avgLoss').textContent = formatCurrency(stats.avgLoss);
            document.getElementById('profitFactor').textContent = stats.profitFactor.toFixed(2);

            const drawdownData = TradeJournalAnalytics.drawdownSeries(trades);
            const expectancyValue = TradeJournalAnalytics.expectancy(trades);
            const compliance = TradeJournalAnalytics.complianceStats(trades);

            const maxDrawdownEl = document.getElementById('maxDrawdown');
            const currentDrawdownEl = document.getElementById('currentDrawdown');
            maxDrawdownEl.textContent = formatCurrency(drawdownData.maxDrawdown);
            maxDrawdownEl.className = `metric-value ${drawdownData.maxDrawdown >= 0 ? 'positive' : 'negative'}`;
            currentDrawdownEl.textContent = `Current: ${formatCurrency(drawdownData.currentDrawdown)}`;

            const expectancyEl = document.getElementById('dashboardExpectancy');
            expectancyEl.textContent = formatCurrency(expectancyValue);
            expectancyEl.className = `metric-value ${expectancyValue >= 0 ? 'positive' : 'negative'}`;
            const expectancyPerR = TradeJournalAnalytics.expectancyPerR(trades);
            const expectancyMeta = document.getElementById('dashboardExpectancyMeta');
            expectancyMeta.textContent = expectancyPerR !== null ? `Avg R: ${expectancyPerR.toFixed(2)}` : 'Per trade';

            const violationCostEl = document.getElementById('violationCost');
            violationCostEl.textContent = formatCurrency(compliance.violationCost);
            violationCostEl.className = `metric-value ${compliance.violationCost >= 0 ? 'positive' : 'negative'}`;
            const offPlanRate = trades.length ? 100 - compliance.followedRate : 0;
            document.getElementById('violationRate').textContent = `${offPlanRate.toFixed(1)}% off-plan`;
            const complianceScoreEl = document.getElementById('complianceScore');
            if (complianceScoreEl) {
                complianceScoreEl.textContent = `${compliance.followedRate.toFixed(1)}%`;
                complianceScoreEl.className = `behavior-value ${compliance.followedRate >= 70 ? 'positive' : 'negative'}`;
            }

            // P&L Chart
            renderPnLChart(currentPnLView);

            // Recent trades
            renderRecentTrades();

            // Top setups
            renderTopSetups();

            // Dashboard heatmap
            renderDashboardHeatmap();

            // Streak
            document.getElementById('currentStreak').textContent = calculateStreak();
        }

        function calculateStats(tradeList = trades) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

            let totalPnL = 0;
            let dailyPnL = 0;
            let weeklyPnL = 0;
            let wins = 0;
            let losses = 0;
            let totalWinAmount = 0;
            let totalLossAmount = 0;

            tradeList.forEach(trade => {
                const tradeDate = new Date(trade.date);
                totalPnL += trade.pnl;

                if (tradeDate >= today) {
                    dailyPnL += trade.pnl;
                }

                if (tradeDate >= weekAgo) {
                    weeklyPnL += trade.pnl;
                }

                if (trade.pnl > 0) {
                    wins++;
                    totalWinAmount += trade.pnl;
                } else if (trade.pnl < 0) {
                    losses++;
                    totalLossAmount += Math.abs(trade.pnl);
                }
            });

            const winRate = tradeList.length > 0 ? (wins / tradeList.length) * 100 : 0;
            const avgWin = wins > 0 ? totalWinAmount / wins : 0;
            const avgLoss = losses > 0 ? totalLossAmount / losses : 0;
            const profitFactor = totalLossAmount > 0 ? totalWinAmount / totalLossAmount : 0;

            return {
                totalPnL,
                dailyPnL,
                weeklyPnL,
                winRate,
                wins,
                losses,
                avgWin,
                avgLoss,
                profitFactor
            };
        }

        function switchPnLChart(view) {
            currentPnLView = view;
            
            // Update button states
            document.querySelectorAll('.chart-controls .chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderPnLChart(view);
        }

        function renderPnLChart(view) {
            const chart = document.getElementById('pnlChart');
            chart.innerHTML = '';

            let data = [];
            let labels = [];

            if (view === 'daily') {
                // Last 7 days
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    labels.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
                    data.push({ date: dateStr, pnl: 0 });
                }

                trades.forEach(trade => {
                    const dateStr = trade.date.split('T')[0];
                    const dataPoint = data.find(d => d.date === dateStr);
                    if (dataPoint) dataPoint.pnl += trade.pnl;
                });

            } else if (view === 'weekly') {
                // Last 8 weeks
                for (let i = 7; i >= 0; i--) {
                    const endDate = new Date();
                    endDate.setDate(endDate.getDate() - (i * 7));
                    const startDate = new Date(endDate);
                    startDate.setDate(startDate.getDate() - 6);
                    
                    labels.push(`W${8-i}`);
                    data.push({ 
                        start: startDate.toISOString().split('T')[0], 
                        end: endDate.toISOString().split('T')[0], 
                        pnl: 0 
                    });
                }

                trades.forEach(trade => {
                    const dateStr = trade.date.split('T')[0];
                    const dataPoint = data.find(d => dateStr >= d.start && dateStr <= d.end);
                    if (dataPoint) dataPoint.pnl += trade.pnl;
                });

            } else if (view === 'monthly') {
                // Last 6 months
                for (let i = 5; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(date.getMonth() - i);
                    labels.push(date.toLocaleDateString('en-US', { month: 'short' }));
                    data.push({ 
                        month: date.getMonth(), 
                        year: date.getFullYear(), 
                        pnl: 0 
                    });
                }

                trades.forEach(trade => {
                    const tradeDate = new Date(trade.date);
                    const dataPoint = data.find(d => 
                        d.month === tradeDate.getMonth() && 
                        d.year === tradeDate.getFullYear()
                    );
                    if (dataPoint) dataPoint.pnl += trade.pnl;
                });
            }

            const maxPnL = Math.max(...data.map(d => Math.abs(d.pnl)), 100);

            data.forEach((item, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'chart-bar-wrapper';
                
                const height = (Math.abs(item.pnl) / maxPnL) * 100;
                const bar = document.createElement('div');
                bar.className = `chart-bar-modern ${item.pnl < 0 ? 'negative' : ''}`;
                bar.style.height = height + '%';
                
                const value = document.createElement('div');
                value.className = 'chart-bar-value';
                value.style.color = item.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)';
                value.textContent = formatCurrency(item.pnl);
                
                const label = document.createElement('div');
                label.className = 'chart-bar-label';
                label.textContent = labels[index];
                
                bar.appendChild(value);
                wrapper.appendChild(bar);
                wrapper.appendChild(label);
                chart.appendChild(wrapper);
            });
        }

        function renderRecentTrades() {
            const tbody = document.getElementById('recentTradesTable');
            const recentTrades = trades.slice(-5).reverse();

            if (recentTrades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No trades yet</td></tr>';
                return;
            }

            tbody.innerHTML = recentTrades.map(trade => `
                <tr onclick="viewTradeDetails(${trade.id})" style="cursor: pointer;">
                    <td>${trade.symbol}</td>
                    <td><span class="badge badge-${trade.direction}">${trade.direction.toUpperCase()}</span></td>
                    <td style="color: ${trade.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}">${formatCurrency(trade.pnl)}</td>
                    <td>${formatDate(trade.date)}</td>
                </tr>
            `).join('');
        }

        function renderTopSetups() {
            const setupStats = {};

            trades.forEach(trade => {
                if (!setupStats[trade.setup]) {
                    setupStats[trade.setup] = { wins: 0, total: 0, pnl: 0 };
                }
                setupStats[trade.setup].total++;
                setupStats[trade.setup].pnl += trade.pnl;
                if (trade.pnl > 0) setupStats[trade.setup].wins++;
            });

            const sortedSetups = Object.entries(setupStats)
                .sort((a, b) => b[1].pnl - a[1].pnl)
                .slice(0, 3);

            const container = document.getElementById('topSetups');
            
            if (sortedSetups.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">No data yet</div>';
                return;
            }

            container.innerHTML = sortedSetups.map(([setup, stats]) => {
                const winRate = (stats.wins / stats.total * 100).toFixed(1);
                return `
                    <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>${setup.charAt(0).toUpperCase() + setup.slice(1)}</strong>
                            <span style="color: ${stats.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}">${formatCurrency(stats.pnl)}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            Win Rate: ${winRate}% (${stats.wins}/${stats.total})
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderDashboardHeatmap() {
            const grid = document.getElementById('dashboardCalendarGrid');
            const legend = document.getElementById('dashboardCalendarLegend');
            const detail = document.getElementById('dashboardDayDetail');
            if (!grid || !legend || !detail) return;

            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const monthLabel = today.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const dailyPnL = {};
            const dailyCount = {};
            trades.forEach(trade => {
                const dateStr = trade.date.split('T')[0];
                if (!dailyPnL[dateStr]) dailyPnL[dateStr] = 0;
                if (!dailyCount[dateStr]) dailyCount[dateStr] = 0;
                dailyPnL[dateStr] += trade.pnl;
                dailyCount[dateStr] += 1;
            });

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startDay = new Date(year, month, 1).getDay();
            const maxAbs = Math.max(...Object.values(dailyPnL).map(pnl => Math.abs(pnl)), 1);

            legend.innerHTML = `
                <span>${monthLabel}</span>
                <span>Daily P/L intensity</span>
            `;

            grid.innerHTML = '';
            for (let i = 0; i < startDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'heatmap-cell empty';
                grid.appendChild(empty);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const pnl = dailyPnL[dateStr] || 0;
                const count = dailyCount[dateStr] || 0;
                const intensity = Math.min(Math.abs(pnl) / maxAbs, 1);
                const status = pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : 'neutral';

                const cell = document.createElement('button');
                cell.type = 'button';
                cell.className = `heatmap-cell ${status}`;
                cell.style.setProperty('--intensity', intensity.toFixed(2));
                cell.textContent = day;
                cell.title = count
                    ? `${dateStr}: ${formatCurrency(pnl)} (${count} trades)`
                    : `${dateStr}: No trades`;
                cell.onclick = () => renderDashboardDayDetail(dateStr);
                grid.appendChild(cell);
            }
        }

        function renderDashboardDayDetail(dateStr) {
            const detail = document.getElementById('dashboardDayDetail');
            if (!detail) return;
            const dayTrades = trades.filter(trade => trade.date.startsWith(dateStr));
            if (!dayTrades.length) {
                detail.innerHTML = `
                    <div class="empty-state">
                        <span>üìÜ</span>
                        <div>No trades logged for ${formatDate(dateStr)}</div>
                    </div>
                `;
                return;
            }

            const pnl = dayTrades.reduce((sum, trade) => sum + trade.pnl, 0);
            const wins = dayTrades.filter(trade => trade.pnl > 0).length;
            const winRate = dayTrades.length ? (wins / dayTrades.length) * 100 : 0;

            detail.innerHTML = `
                <div class="day-detail-header">
                    <div>
                        <div class="card-title">${formatDate(dateStr)}</div>
                        <div class="card-subtitle">${dayTrades.length} trades ¬∑ ${winRate.toFixed(1)}% win rate</div>
                    </div>
                    <div class="metric-value ${pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pnl)}</div>
                </div>
                <div class="day-detail-list">
                    ${dayTrades.map(trade => `
                        <div class="day-detail-item" onclick="viewTradeDetails(${trade.id})">
                            <div>
                                <strong>${trade.symbol}</strong>
                                <span class="badge badge-${trade.direction}">${trade.direction.toUpperCase()}</span>
                                <span class="day-detail-meta">${formatDateTime(trade.date)}</span>
                            </div>
                            <span class="day-detail-pnl ${trade.pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(trade.pnl)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function calculateStreak() {
            const tradingDays = {};
            
            trades.forEach(trade => {
                const dateStr = trade.date.split('T')[0];
                tradingDays[dateStr] = true;
            });

            let streak = 0;
            const today = new Date();
            
            for (let i = 0; i < 365; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                if (tradingDays[dateStr]) {
                    streak++;
                } else if (i > 0) {
                    break;
                }
            }

            return streak;
        }
        // ========== JOURNAL FUNCTIONS ==========
        function renderJournal() {
            const tbody = document.getElementById('journalTable');
            
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: var(--text-secondary); padding: 3rem;">No trades recorded yet. Add your first trade!</td></tr>';
                updateFilterOptions();
                return;
            }

            const sortedTrades = [...trades].reverse();

            tbody.innerHTML = sortedTrades.map(trade => {
                const followedPlan = trade.followedPlan === 'yes';
                const flagIcon = !followedPlan ? '<span class="strategy-flag" title="Deviated from strategy plan"><span class="flag-icon">‚ö†Ô∏è</span></span>' : '';
                
                return `
                    <tr>
                        <td>${formatDateTime(trade.date)}</td>
                        <td><strong>${trade.symbol}</strong></td>
                        <td><span class="badge badge-${trade.direction}">${trade.direction.toUpperCase()}</span></td>
                        <td>$${trade.entry.toFixed(2)}</td>
                        <td>$${trade.exit.toFixed(2)}</td>
                        <td>${trade.quantity}</td>
                        <td><span class="badge badge-${trade.pnl >= 0 ? 'win' : 'loss'}">${formatCurrency(trade.pnl)}</span></td>
                        <td>${trade.setup}</td>
                        <td>${flagIcon} ${followedPlan ? '<span style="color: var(--accent-primary);">‚úì</span>' : '<span style="color: var(--accent-danger);">‚úó</span>'}</td>
                        <td>
                            <button class="btn btn-small btn-secondary" onclick="viewTradeDetails(${trade.id})">View</button>
                            <button class="btn btn-small btn-danger" onclick="deleteTrade(${trade.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');

            updateFilterOptions();
        }

        function updateFilterOptions() {
            const symbols = [...new Set(trades.map(t => t.symbol))];
            const symbolFilter = document.getElementById('filterSymbol');
            
            symbolFilter.innerHTML = '<option value="">All Symbols</option>' +
                symbols.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function getFilterState() {
            return {
                filterDateFrom: document.getElementById('filterDateFrom').value,
                filterDateTo: document.getElementById('filterDateTo').value,
                filterSymbol: document.getElementById('filterSymbol').value,
                filterSetup: document.getElementById('filterSetup').value,
                filterResult: document.getElementById('filterResult').value,
                filterCompliance: document.getElementById('filterCompliance').value
            };
        }

        function setFilterState(filters) {
            document.getElementById('filterDateFrom').value = filters.filterDateFrom || '';
            document.getElementById('filterDateTo').value = filters.filterDateTo || '';
            document.getElementById('filterSymbol').value = filters.filterSymbol || '';
            document.getElementById('filterSetup').value = filters.filterSetup || '';
            document.getElementById('filterResult').value = filters.filterResult || '';
            document.getElementById('filterCompliance').value = filters.filterCompliance || '';
        }

        function renderViewsDropdown() {
            const select = document.getElementById('savedViewsSelect');
            if (!select) return;
            select.innerHTML = '<option value="">Saved views</option>' +
                savedViews.map(view => `<option value="${view.id}">${view.name}</option>`).join('');
            if (currentViewId) {
                select.value = currentViewId;
            }
        }

        function initializeSavedViews() {
            const select = document.getElementById('savedViewsSelect');
            if (!select) return;
            select.addEventListener('change', () => {
                currentViewId = select.value;
                const view = savedViews.find(item => item.id === currentViewId);
                if (view) {
                    setFilterState(view.filters);
                    applyFilters();
                } else {
                    clearFilters();
                }
            });
        }

        async function saveCurrentView() {
            const name = prompt('Name this view');
            if (!name) return;
            const view = {
                id: `view_${Date.now()}`,
                name,
                account: currentAccount,
                filters: getFilterState(),
                createdAt: new Date().toISOString()
            };
            if (isDbReady) {
                await TradeJournalDB.saveView(view);
                savedViews.push(view);
                currentViewId = view.id;
                renderViewsDropdown();
                showToast('View saved', 'success');
            }
        }

        async function updateCurrentView() {
            if (!currentViewId) {
                alert('Select a view to update.');
                return;
            }
            const view = savedViews.find(item => item.id === currentViewId);
            if (!view) return;
            view.filters = getFilterState();
            view.updatedAt = new Date().toISOString();
            if (isDbReady) {
                await TradeJournalDB.saveView(view);
                renderViewsDropdown();
                showToast('View updated', 'success');
            }
        }

        async function deleteCurrentView() {
            if (!currentViewId) {
                alert('Select a view to delete.');
                return;
            }
            if (!confirm('Delete this saved view?')) return;
            if (isDbReady) {
                await TradeJournalDB.deleteView(currentViewId);
            }
            savedViews = savedViews.filter(item => item.id !== currentViewId);
            currentViewId = '';
            renderViewsDropdown();
            showToast('View deleted', 'success');
            clearFilters();
        }

        function applyFilters() {
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const symbol = document.getElementById('filterSymbol').value;
            const setup = document.getElementById('filterSetup').value;
            const result = document.getElementById('filterResult').value;
            const compliance = document.getElementById('filterCompliance').value;

            let filtered = trades;

            if (dateFrom) {
                filtered = filtered.filter(t => t.date.split('T')[0] >= dateFrom);
            }
            if (dateTo) {
                filtered = filtered.filter(t => t.date.split('T')[0] <= dateTo);
            }
            if (symbol) {
                filtered = filtered.filter(t => t.symbol === symbol);
            }
            if (setup) {
                filtered = filtered.filter(t => t.setup === setup);
            }
            if (result === 'win') {
                filtered = filtered.filter(t => t.pnl > 0);
            } else if (result === 'loss') {
                filtered = filtered.filter(t => t.pnl < 0);
            }
            if (compliance) {
                filtered = filtered.filter(t => t.followedPlan === compliance);
            }

            renderFilteredJournal(filtered);
        }

        function clearFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterSymbol').value = '';
            document.getElementById('filterSetup').value = '';
            document.getElementById('filterResult').value = '';
            document.getElementById('filterCompliance').value = '';
            currentViewId = '';
            renderViewsDropdown();
            renderJournal();
        }

        function renderFilteredJournal(filtered) {
            const tbody = document.getElementById('journalTable');
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: var(--text-secondary); padding: 3rem;">No trades match your filters</td></tr>';
                return;
            }

            const sortedTrades = [...filtered].reverse();

            tbody.innerHTML = sortedTrades.map(trade => {
                const followedPlan = trade.followedPlan === 'yes';
                const flagIcon = !followedPlan ? '<span class="strategy-flag" title="Deviated from strategy plan"><span class="flag-icon">‚ö†Ô∏è</span></span>' : '';
                
                return `
                    <tr class="trade-row" onclick="viewTradeDetails(${trade.id})">
                        <td>${formatDateTime(trade.date)}</td>
                        <td><strong>${trade.symbol}</strong></td>
                        <td><span class="badge badge-${trade.direction}">${trade.direction.toUpperCase()}</span></td>
                        <td class="text-right">$${trade.entry.toFixed(2)}</td>
                        <td class="text-right">$${trade.exit.toFixed(2)}</td>
                        <td class="text-right">${trade.quantity}</td>
                        <td class="text-right"><span class="badge badge-${trade.pnl >= 0 ? 'win' : 'loss'}">${formatCurrency(trade.pnl)}</span></td>
                        <td>${trade.setup}</td>
                        <td>${flagIcon} ${followedPlan ? '<span style="color: var(--accent-primary);">‚úì</span>' : '<span style="color: var(--accent-danger);">‚úó</span>'}</td>
                        <td class="actions-cell">
                            <button class="btn btn-small btn-secondary" onclick="event.stopPropagation(); viewTradeDetails(${trade.id})">View</button>
                            <button class="btn btn-small btn-danger" onclick="event.stopPropagation(); deleteTrade(${trade.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewTradeDetails(id) {
            const trade = trades.find(t => t.id === id);
            if (!trade) return;

            const followedPlan = trade.followedPlan === 'yes';
            const replay = trade.replay || { steps: [], mistakes: '', improvements: '' };
            const replaySteps = ['Thesis', 'Entry', 'Management', 'Exit', 'Review'];
            const imageHtml = (trade.images || []).map(image => {
                const src = image.blob
                    ? URL.createObjectURL(image.blob)
                    : image.data
                        ? `data:${image.type};base64,${image.data}`
                        : '';
                if (!src) return '';
                return `<div class="image-preview-card"><img src="${src}" alt="Trade attachment" style="width: 100%; height: 100%; object-fit: cover;"></div>`;
            }).join('');
            const imagesSection = imageHtml
                ? `
                    <div>
                        <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Attachments</div>
                        <div class="image-preview-grid">${imageHtml}</div>
                    </div>
                `
                : '';

            const content = document.getElementById('tradeDetailContent');
            content.innerHTML = `
                <div class="trade-detail-tabs">
                    <button class="trade-tab active" data-trade-tab="overview" onclick="switchTradeDetailTab('overview')">Overview</button>
                    <button class="trade-tab" data-trade-tab="replay" onclick="switchTradeDetailTab('replay')">Replay</button>
                    <button class="trade-tab" data-trade-tab="attachments" onclick="switchTradeDetailTab('attachments')">Attachments</button>
                </div>
                <div class="trade-detail-body">
                    <div class="trade-detail-panel active" data-trade-panel="overview">
                        <div class="metric-card">
                            <h3>${trade.symbol} - ${trade.direction.toUpperCase()}</h3>
                            <p style="color: var(--text-secondary);">${formatDateTime(trade.date)}</p>
                            ${!followedPlan ? '<div class="badge badge-warning" style="margin-top: 0.5rem;">‚ö†Ô∏è Deviated from Strategy</div>' : '<div class="badge badge-win" style="margin-top: 0.5rem;">‚úì Followed Strategy</div>'}
                        </div>

                        <div class="grid-2">
                            <div>
                                <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Entry Price</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">$${trade.entry.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Exit Price</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">$${trade.exit.toFixed(2)}</div>
                            </div>
                        </div>

                        <div class="grid-2">
                            <div>
                                <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Quantity</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">${trade.quantity}</div>
                            </div>
                            <div>
                                <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">P&L</div>
                                <div style="font-size: 1.2rem; font-weight: bold; color: ${trade.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}">${formatCurrency(trade.pnl)}</div>
                            </div>
                        </div>

                        ${trade.stopLoss ? `
                        <div class="grid-2">
                            <div>
                                <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Stop Loss</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">$${trade.stopLoss.toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Take Profit</div>
                                <div style="font-size: 1.2rem; font-weight: bold;">$${trade.takeProfit ? trade.takeProfit.toFixed(2) : 'N/A'}</div>
                            </div>
                        </div>
                        ` : ''}

                        <div>
                            <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Setup</div>
                            <div><span class="badge">${trade.setup}</span></div>
                        </div>

                        <div>
                            <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Timeframe</div>
                            <div><span class="badge">${trade.timeframe}</span></div>
                        </div>

                        ${trade.emotion ? `
                        <div>
                            <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Emotional State</div>
                            <div><span class="badge">${trade.emotion}</span></div>
                        </div>
                        ` : ''}

                        ${!followedPlan && trade.deviationReason ? `
                        <div>
                            <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Reason for Deviation</div>
                            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 4px; border-left: 3px solid var(--accent-warning);">${trade.deviationReason}</div>
                        </div>
                        ` : ''}

                        ${trade.notes ? `
                        <div>
                            <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Notes</div>
                            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 4px;">${trade.notes}</div>
                        </div>
                        ` : ''}

                        ${trade.mistakes ? `
                        <div>
                            <div style="margin-bottom: 0.5rem; color: var(--text-secondary);">Mistakes</div>
                            <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 4px;">${trade.mistakes}</div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="trade-detail-panel" data-trade-panel="replay">
                        <div class="replay-timeline">
                            <div class="timeline-step">
                                <div class="timeline-dot"></div>
                                <div>
                                    <div class="timeline-title">Entry</div>
                                    <div class="timeline-meta">${formatDateTime(trade.date)}</div>
                                </div>
                            </div>
                            <div class="timeline-step">
                                <div class="timeline-dot"></div>
                                <div>
                                    <div class="timeline-title">Exit</div>
                                    <div class="timeline-meta">Exit price recorded ¬∑ time not logged</div>
                                </div>
                            </div>
                        </div>
                        <div class="replay-section">
                            <div class="card-title">Lifecycle Checklist</div>
                            <div class="replay-steps">
                                ${replaySteps.map(step => `
                                    <label class="replay-step">
                                        <input type="checkbox" value="${step}" ${replay.steps.includes(step) ? 'checked' : ''}>
                                        <span>${step}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                        <div class="replay-section">
                            <label class="form-label">Mistake moments</label>
                            <textarea class="form-textarea" id="replayMistakes" placeholder="Tag the moments you would change...">${replay.mistakes || ''}</textarea>
                        </div>
                        <div class="replay-section">
                            <label class="form-label">What I'd do differently</label>
                            <textarea class="form-textarea" id="replayImprovements" placeholder="Rewrite the play-by-play for next time.">${replay.improvements || ''}</textarea>
                        </div>
                        <button class="btn btn-primary btn-small" onclick="saveTradeReplay(${trade.id})">Save Replay Notes</button>
                    </div>
                    <div class="trade-detail-panel" data-trade-panel="attachments">
                        ${imagesSection || '<div class=\"empty-state\"><span>üñºÔ∏è</span><div>No attachments uploaded.</div></div>'}
                    </div>
                </div>
            `;

            document.getElementById('tradeDetailModal').classList.add('active');
        }

        function switchTradeDetailTab(tabName) {
            document.querySelectorAll('.trade-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tradeTab === tabName);
            });
            document.querySelectorAll('.trade-detail-panel').forEach(panel => {
                panel.classList.toggle('active', panel.dataset.tradePanel === tabName);
            });
        }

        async function saveTradeReplay(tradeId) {
            const trade = trades.find(t => t.id === tradeId);
            if (!trade) return;

            const steps = Array.from(document.querySelectorAll('.replay-step input:checked')).map(input => input.value);
            const mistakes = document.getElementById('replayMistakes')?.value || '';
            const improvements = document.getElementById('replayImprovements')?.value || '';

            trade.replay = { steps, mistakes, improvements, updatedAt: new Date().toISOString() };
            allTrades[currentAccount] = trades.map(stripTradeImages);
            localStorage.setItem('allTrades', JSON.stringify(allTrades));

            if (isDbReady) {
                await TradeJournalDB.saveTrade(trade);
            }

            showToast('Replay notes saved', 'success');
        }

        async function deleteTrade(id) {
            if (!confirm('Are you sure you want to delete this trade?')) return;

            trades = trades.filter(t => t.id !== id);
            allTrades[currentAccount] = trades.map(stripTradeImages);
            localStorage.setItem('allTrades', JSON.stringify(allTrades));

            if (isDbReady) {
                await TradeJournalDB.deleteTrade(id);
            }
            
            renderJournal();
            updateDashboard();
            renderAnalytics();
            renderDataAnalysis();
        }
        // ========== DATA ANALYSIS FUNCTIONS ==========
        function renderDataAnalysis() {
            if (trades.length === 0) {
                // Show empty state for all sections
                document.getElementById('analysisWins').textContent = '0';
                document.getElementById('analysisLosses').textContent = '0';
                document.getElementById('analysisTotalTrades').textContent = '0';
                document.getElementById('analysisWinRate').textContent = '0%';
                document.getElementById('analysisAvgRR').textContent = '0:0';
                document.getElementById('analysisTotalPnL').textContent = '$0';
                document.getElementById('reportBestDayValue').textContent = '$0.00';
                document.getElementById('reportBestDayDate').textContent = 'No data yet';
                document.getElementById('reportWorstDayValue').textContent = '$0.00';
                document.getElementById('reportWorstDayDate').textContent = 'No data yet';
                document.getElementById('reportBestDay').textContent = '$0.00';
                document.getElementById('reportBestDayMeta').textContent = 'No data yet';
                document.getElementById('reportTopSetup').textContent = '--';
                document.getElementById('reportTopSetupMeta').textContent = 'Awaiting trades';
                document.getElementById('reportCompliance').textContent = '0%';
                document.getElementById('reportComplianceMeta').textContent = '0 off-plan trades';
                document.getElementById('reportExpectancy').textContent = '$0.00';
                document.getElementById('reportDayTime').textContent = '--';
                document.getElementById('reportOffPlanTrades').textContent = '0';
                document.getElementById('reportOffPlanRate').textContent = '0% of trades';
                document.getElementById('reportViolationCost').textContent = '$0.00';
                document.getElementById('reportBadHabitCallout').textContent = 'No habit data yet.';
                document.getElementById('reportExpectancyValue').textContent = '$0.00';
                document.getElementById('reportExpectancyR').textContent = '0.00';
                const topSetupsList = document.getElementById('reportTopSetupsList');
                if (topSetupsList) {
                    topSetupsList.innerHTML = '<div class=\"report-empty\">No setup data yet.</div>';
                }
                return;
            }

            // Overall summary
            const stats = calculateStats();
            document.getElementById('analysisWins').textContent = stats.wins;
            document.getElementById('analysisLosses').textContent = stats.losses;
            document.getElementById('analysisTotalTrades').textContent = trades.length;
            document.getElementById('analysisWinRate').textContent = stats.winRate.toFixed(1) + '%';
            
            // Calculate average R:R
            const avgRR = calculateAverageRR();
            document.getElementById('analysisAvgRR').textContent = avgRR;
            document.getElementById('analysisTotalPnL').textContent = formatCurrency(stats.totalPnL);
            document.getElementById('analysisTotalPnL').className = `summary-stat-value ${stats.totalPnL >= 0 ? 'positive' : 'negative'}`;

            const expectancy = TradeJournalAnalytics.expectancy(trades);
            const expectancyPerR = TradeJournalAnalytics.expectancyPerR(trades);
            const compliance = TradeJournalAnalytics.complianceStats(trades);

            const dailyPnL = {};
            trades.forEach(trade => {
                const dateStr = trade.date.split('T')[0];
                if (!dailyPnL[dateStr]) dailyPnL[dateStr] = 0;
                dailyPnL[dateStr] += trade.pnl;
            });

            const sortedDays = Object.entries(dailyPnL).sort((a, b) => b[1] - a[1]);
            const bestDay = sortedDays[0];
            const worstDay = sortedDays[sortedDays.length - 1];

            if (bestDay) {
                document.getElementById('reportBestDayValue').textContent = formatCurrency(bestDay[1]);
                document.getElementById('reportBestDayDate').textContent = formatDate(bestDay[0]);
                document.getElementById('reportBestDay').textContent = formatCurrency(bestDay[1]);
                document.getElementById('reportBestDayMeta').textContent = formatDate(bestDay[0]);
            }

            if (worstDay) {
                document.getElementById('reportWorstDayValue').textContent = formatCurrency(worstDay[1]);
                document.getElementById('reportWorstDayDate').textContent = formatDate(worstDay[0]);
            }

            const setupStats = TradeJournalAnalytics.setupPerformance(trades);
            const topSetup = setupStats[0];
            if (topSetup) {
                document.getElementById('reportTopSetup').textContent = topSetup.setup;
                document.getElementById('reportTopSetupMeta').textContent = `${formatCurrency(topSetup.pnl)} ¬∑ ${topSetup.trades} trades`;
            }

            const topSetupsList = document.getElementById('reportTopSetupsList');
            if (topSetupsList) {
                topSetupsList.innerHTML = setupStats.slice(0, 5).map(setup => `
                    <div class="report-row">
                        <div>
                            <strong>${setup.setup}</strong>
                            <div class="report-sub">${setup.trades} trades ¬∑ ${setup.winRate.toFixed(1)}% WR</div>
                        </div>
                        <span class="${setup.pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(setup.pnl)}</span>
                    </div>
                `).join('') || '<div class="report-empty">No setup data yet.</div>';
            }

            const offPlanTrades = trades.filter(trade => trade.followedPlan === 'no');
            document.getElementById('reportCompliance').textContent = `${compliance.followedRate.toFixed(1)}%`;
            document.getElementById('reportComplianceMeta').textContent = `${offPlanTrades.length} off-plan trades`;
            document.getElementById('reportOffPlanTrades').textContent = offPlanTrades.length;
            document.getElementById('reportOffPlanRate').textContent = `${trades.length ? ((offPlanTrades.length / trades.length) * 100).toFixed(1) : 0}% of trades`;
            document.getElementById('reportViolationCost').textContent = formatCurrency(compliance.violationCost);
            document.getElementById('reportBadHabitCallout').textContent = offPlanTrades.length
                ? `Off-plan trades resulted in ${formatCurrency(compliance.violationCost)} net impact.`
                : 'No off-plan trades logged yet.';

            document.getElementById('reportExpectancy').textContent = formatCurrency(expectancy);
            document.getElementById('reportExpectancyValue').textContent = formatCurrency(expectancy);
            document.getElementById('reportExpectancyR').textContent = expectancyPerR !== null ? expectancyPerR.toFixed(2) : '0.00';

            const weekdayPnL = {};
            trades.forEach(trade => {
                const dayName = new Date(trade.date).toLocaleDateString('en-US', { weekday: 'long' });
                if (!weekdayPnL[dayName]) weekdayPnL[dayName] = 0;
                weekdayPnL[dayName] += trade.pnl;
            });
            const bestDayName = Object.entries(weekdayPnL).sort((a, b) => b[1] - a[1])[0];
            if (bestDayName) {
                document.getElementById('reportDayTime').textContent = `${bestDayName[0]} (${formatCurrency(bestDayName[1])})`;
            }

            // Render all analysis sections
            renderDayOfWeekAnalysis();
            renderLongShortAnalysis();
            renderContractAnalysis();
            renderSessionAnalysis();
            renderSetupDetailedAnalysis();
            renderComplianceAnalysis();
            renderTimeframeAnalysis();
            renderTopBottomSymbols();
            calculateLongestStreaks();
        }

        function calculateAverageRR() {
            const rrTrades = trades.filter(t => t.stopLoss && t.takeProfit);
            if (rrTrades.length === 0) return '0:0';

            let totalRR = 0;
            rrTrades.forEach(trade => {
                const risk = Math.abs(trade.entry - trade.stopLoss);
                const reward = Math.abs(trade.takeProfit - trade.entry);
                if (risk > 0) totalRR += reward / risk;
            });

            const avgRR = (totalRR / rrTrades.length).toFixed(2);
            return `1:${avgRR}`;
        }

        // Day of Week Analysis
        function renderDayOfWeekAnalysis() {
            const dayStats = {
                'Sunday': { wins: 0, losses: 0, pnl: 0, total: 0 },
                'Monday': { wins: 0, losses: 0, pnl: 0, total: 0 },
                'Tuesday': { wins: 0, losses: 0, pnl: 0, total: 0 },
                'Wednesday': { wins: 0, losses: 0, pnl: 0, total: 0 },
                'Thursday': { wins: 0, losses: 0, pnl: 0, total: 0 },
                'Friday': { wins: 0, losses: 0, pnl: 0, total: 0 },
                'Saturday': { wins: 0, losses: 0, pnl: 0, total: 0 }
            };

            trades.forEach(trade => {
                const dayName = new Date(trade.date).toLocaleDateString('en-US', { weekday: 'long' });
                dayStats[dayName].total++;
                dayStats[dayName].pnl += trade.pnl;
                if (trade.pnl > 0) dayStats[dayName].wins++;
                else if (trade.pnl < 0) dayStats[dayName].losses++;
            });

            const container = document.getElementById('dayOfWeekAnalysis');

            container.innerHTML = Object.entries(dayStats).map(([day, stats]) => {
                if (stats.total === 0) return '';
                
                const winRate = stats.total > 0 ? (stats.wins / stats.total) * 100 : 0;
                const barWidth = winRate;
                const winRateLabel = winRate.toFixed(1);
                const barGradient = winRate >= 50
                    ? 'linear-gradient(90deg, var(--accent-primary), var(--accent-secondary))'
                    : 'linear-gradient(90deg, var(--accent-danger), #cc0033)';

                return `
                    <div class="comparison-row">
                        <div class="comparison-label">
                            <strong>${day}</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${stats.total} trades</div>
                        </div>
                        <div class="comparison-bar">
                            <div class="comparison-bar-fill" style="width: ${barWidth}%; background: ${barGradient}">
                                WR: ${winRateLabel}%
                            </div>
                        </div>
                        <div class="comparison-value" style="color: ${stats.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}">
                            ${formatCurrency(stats.pnl)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Long vs Short Analysis
        function renderLongShortAnalysis() {
            const longStats = { wins: 0, losses: 0, pnl: 0, total: 0 };
            const shortStats = { wins: 0, losses: 0, pnl: 0, total: 0 };

            trades.forEach(trade => {
                const stats = trade.direction === 'long' ? longStats : shortStats;
                stats.total++;
                stats.pnl += trade.pnl;
                if (trade.pnl > 0) stats.wins++;
                else if (trade.pnl < 0) stats.losses++;
            });

            const container = document.getElementById('longShortAnalysis');
            const longWinRate = longStats.total > 0 ? (longStats.wins / longStats.total) * 100 : 0;
            const shortWinRate = shortStats.total > 0 ? (shortStats.wins / shortStats.total) * 100 : 0;
            const longWR = longWinRate.toFixed(1);
            const shortWR = shortWinRate.toFixed(1);
            const longBarWidth = longWinRate;
            const shortBarWidth = shortWinRate;
            const longGradient = longWinRate >= 50
                ? 'linear-gradient(90deg, var(--accent-primary), var(--accent-secondary))'
                : 'linear-gradient(90deg, var(--accent-danger), #cc0033)';
            const shortGradient = shortWinRate >= 50
                ? 'linear-gradient(90deg, var(--accent-primary), var(--accent-secondary))'
                : 'linear-gradient(90deg, var(--accent-danger), #cc0033)';

            container.innerHTML = `
                <div class="comparison-row">
                    <div class="comparison-label">
                        <strong>Long Positions</strong>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${longStats.total} trades</div>
                    </div>
                    <div class="comparison-bar">
                        <div class="comparison-bar-fill" style="width: ${longBarWidth}%; background: ${longGradient}">
                            WR: ${longWR}%
                        </div>
                    </div>
                    <div class="comparison-value" style="color: ${longStats.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}">
                        ${formatCurrency(longStats.pnl)}
                    </div>
                </div>
                <div class="comparison-row">
                    <div class="comparison-label">
                        <strong>Short Positions</strong>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${shortStats.total} trades</div>
                    </div>
                    <div class="comparison-bar">
                        <div class="comparison-bar-fill" style="width: ${shortBarWidth}%; background: ${shortGradient}">
                            WR: ${shortWR}%
                        </div>
                    </div>
                    <div class="comparison-value" style="color: ${shortStats.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}">
                        ${formatCurrency(shortStats.pnl)}
                    </div>
                </div>
            `;

            // Pie chart
            const pieContainer = document.getElementById('longShortPieChart');
            const totalTrades = longStats.total + shortStats.total;
            
            if (totalTrades === 0) {
                pieContainer.innerHTML = '<div style="color: var(--text-secondary);">No data yet</div>';
                return;
            }

            const longPercent = ((longStats.total / totalTrades) * 100).toFixed(1);
            const shortPercent = ((shortStats.total / totalTrades) * 100).toFixed(1);

            pieContainer.innerHTML = `
                <div style="text-align: center;">
                    <div style="width: 150px; height: 150px; border-radius: 50%; background: conic-gradient(var(--accent-primary) 0% ${longPercent}%, var(--accent-danger) ${longPercent}% 100%); margin: 0 auto 1rem;"></div>
                </div>
                <div class="pie-legend">
                    <div class="pie-legend-item">
                        <div class="pie-legend-color" style="background: var(--accent-primary);"></div>
                        <div class="pie-legend-label">Long</div>
                        <div class="pie-legend-value">${longPercent}%</div>
                    </div>
                    <div class="pie-legend-item">
                        <div class="pie-legend-color" style="background: var(--accent-danger);"></div>
                        <div class="pie-legend-label">Short</div>
                        <div class="pie-legend-value">${shortPercent}%</div>
                    </div>
                </div>
            `;
        }

        // Contract/Share Size Analysis
        function renderContractAnalysis() {
            const sizeStats = {};

            trades.forEach(trade => {
                const size = trade.quantity;
                if (!sizeStats[size]) {
                    sizeStats[size] = { wins: 0, losses: 0, pnl: 0, total: 0 };
                }
                sizeStats[size].total++;
                sizeStats[size].pnl += trade.pnl;
                if (trade.pnl > 0) sizeStats[size].wins++;
                else if (trade.pnl < 0) sizeStats[size].losses++;
            });

            const container = document.getElementById('contractAnalysis');
            const sortedSizes = Object.entries(sizeStats).sort((a, b) => b[1].pnl - a[1].pnl);

            container.innerHTML = sortedSizes.map(([size, stats]) => {
                const winRate = stats.total > 0 ? (stats.wins / stats.total) * 100 : 0;
                const barWidth = winRate;
                const winRateLabel = winRate.toFixed(1);
                const barGradient = winRate >= 50
                    ? 'linear-gradient(90deg, var(--accent-primary), var(--accent-secondary))'
                    : 'linear-gradient(90deg, var(--accent-danger), #cc0033)';

                return `
                    <div class="comparison-row">
                        <div class="comparison-label">
                            <strong>${size} Contracts/Shares</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${stats.total} trades</div>
                        </div>
                        <div class="comparison-bar">
                            <div class="comparison-bar-fill" style="width: ${barWidth}%; background: ${barGradient}">
                                WR: ${winRateLabel}%
                            </div>
                        </div>
                        <div class="comparison-value" style="color: ${stats.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}">
                            ${formatCurrency(stats.pnl)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Session Analysis
        function renderSessionAnalysis() {
            const container = document.getElementById('sessionAnalysis');
            
            if (tradingSessions.length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">Configure your trading sessions in settings to see session analysis</div>';
                return;
            }

            const sessionStats = {};
            tradingSessions.forEach(session => {
                sessionStats[session.name] = { wins: 0, losses: 0, pnl: 0, total: 0 };
            });

            trades.forEach(trade => {
                const tradeTime = new Date(trade.date).toTimeString().slice(0, 5);
                
                tradingSessions.forEach(session => {
                    if (tradeTime >= session.start && tradeTime <= session.end) {
                        sessionStats[session.name].total++;
                        sessionStats[session.name].pnl += trade.pnl;
                        if (trade.pnl > 0) sessionStats[session.name].wins++;
                        else if (trade.pnl < 0) sessionStats[session.name].losses++;
                    }
                });
            });

            container.innerHTML = Object.entries(sessionStats).map(([session, stats]) => {
                if (stats.total === 0) {
                    return `
                        <div class="comparison-row">
                            <div class="comparison-label">
                                <strong>${session}</strong>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">No trades</div>
                            </div>
                            <div class="comparison-bar">
                                <div class="comparison-bar-fill" style="width: 0%"></div>
                            </div>
                            <div class="comparison-value">$0.00</div>
                        </div>
                    `;
                }

                const winRate = stats.total > 0 ? (stats.wins / stats.total) * 100 : 0;
                const barWidth = winRate;
                const winRateLabel = winRate.toFixed(1);
                const barGradient = winRate >= 50
                    ? 'linear-gradient(90deg, var(--accent-primary), var(--accent-secondary))'
                    : 'linear-gradient(90deg, var(--accent-danger), #cc0033)';

                return `
                    <div class="comparison-row">
                        <div class="comparison-label">
                            <strong>${session}</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${stats.total} trades</div>
                        </div>
                        <div class="comparison-bar">
                            <div class="comparison-bar-fill" style="width: ${barWidth}%; background: ${barGradient}">
                                WR: ${winRateLabel}%
                            </div>
                        </div>
                        <div class="comparison-value" style="color: ${stats.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}">
                            ${formatCurrency(stats.pnl)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openSessionConfig() {
            document.getElementById('sessionConfigModal').classList.add('active');
        }
        // Setup Detailed Analysis
        function renderSetupDetailedAnalysis() {
            const setupStats = {};

            trades.forEach(trade => {
                if (!setupStats[trade.setup]) {
                    setupStats[trade.setup] = { wins: 0, losses: 0, pnl: 0, total: 0, avgWin: 0, avgLoss: 0 };
                }
                setupStats[trade.setup].total++;
                setupStats[trade.setup].pnl += trade.pnl;
                if (trade.pnl > 0) {
                    setupStats[trade.setup].wins++;
                    setupStats[trade.setup].avgWin += trade.pnl;
                } else if (trade.pnl < 0) {
                    setupStats[trade.setup].losses++;
                    setupStats[trade.setup].avgLoss += Math.abs(trade.pnl);
                }
            });

            // Calculate averages
            Object.values(setupStats).forEach(stats => {
                stats.avgWin = stats.wins > 0 ? stats.avgWin / stats.wins : 0;
                stats.avgLoss = stats.losses > 0 ? stats.avgLoss / stats.losses : 0;
            });

            const container = document.getElementById('setupDetailedAnalysis');
            const sortedSetups = Object.entries(setupStats).sort((a, b) => b[1].pnl - a[1].pnl);
            const maxPnL = Math.max(...sortedSetups.map(s => Math.abs(s[1].pnl)), 1);

            container.innerHTML = sortedSetups.map(([setup, stats]) => {
                const winRate = ((stats.wins / stats.total) * 100).toFixed(1);
                const barWidth = (Math.abs(stats.pnl) / maxPnL) * 100;
                const profitFactor = stats.avgLoss > 0 ? (stats.avgWin * stats.wins) / (stats.avgLoss * stats.losses) : 0;

                return `
                    <div class="comparison-row" style="grid-template-columns: 200px 1fr;">
                        <div class="comparison-label">
                            <strong style="text-transform: capitalize;">${setup}</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                ${stats.total} trades | WR: ${winRate}% | PF: ${profitFactor.toFixed(2)}
                            </div>
                        </div>
                        <div>
                            <div class="comparison-bar" style="margin-bottom: 0.5rem;">
                                <div class="comparison-bar-fill" style="width: ${barWidth}%; background: ${stats.pnl >= 0 ? 'linear-gradient(90deg, var(--accent-primary), var(--accent-secondary))' : 'linear-gradient(90deg, var(--accent-danger), #cc0033)'}">
                                    ${formatCurrency(stats.pnl)}
                                </div>
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.75rem; color: var(--text-secondary);">
                                <span>Avg Win: <strong style="color: var(--accent-primary);">${formatCurrency(stats.avgWin)}</strong></span>
                                <span>Avg Loss: <strong style="color: var(--accent-danger);">${formatCurrency(-stats.avgLoss)}</strong></span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Strategy Compliance Analysis
        function renderComplianceAnalysis() {
            const followed = { wins: 0, losses: 0, total: 0, pnl: 0 };
            const deviated = { wins: 0, losses: 0, total: 0, pnl: 0 };

            trades.forEach(trade => {
                const stats = trade.followedPlan === 'yes' ? followed : deviated;
                stats.total++;
                stats.pnl += trade.pnl;
                if (trade.pnl > 0) stats.wins++;
                else if (trade.pnl < 0) stats.losses++;
            });

            const followedWR = followed.total > 0 ? ((followed.wins / followed.total) * 100).toFixed(1) : 0;
            const deviatedWR = deviated.total > 0 ? ((deviated.wins / deviated.total) * 100).toFixed(1) : 0;

            document.getElementById('complianceFollowed').textContent = followed.total;
            document.getElementById('complianceFollowedWR').textContent = `${followedWR}% Win Rate`;
            document.getElementById('complianceFollowedWR').className = `metric-change ${followed.pnl >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('complianceDeviated').textContent = deviated.total;
            document.getElementById('complianceDeviatedWR').textContent = `${deviatedWR}% Win Rate`;
            document.getElementById('complianceDeviatedWR').className = `metric-change ${deviated.pnl >= 0 ? 'positive' : 'negative'}`;

            // Impact comparison
            const wrDifference = followedWR - deviatedWR;
            const barWidth = Math.min(Math.abs(wrDifference), 100);
            
            document.getElementById('complianceImpactBar').style.width = barWidth + '%';
            document.getElementById('complianceImpactBar').style.background = wrDifference >= 0 ? 
                'linear-gradient(90deg, var(--accent-primary), var(--accent-secondary))' : 
                'linear-gradient(90deg, var(--accent-danger), #cc0033)';
            document.getElementById('complianceImpactBar').textContent = 
                `${wrDifference >= 0 ? '+' : ''}${wrDifference.toFixed(1)}% WR Impact`;
            
            document.getElementById('complianceImpactValue').textContent = 
                `${wrDifference >= 0 ? '+' : ''}${wrDifference.toFixed(1)}%`;
            document.getElementById('complianceImpactValue').style.color = 
                wrDifference >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)';
        }

        // Timeframe Analysis
        function renderTimeframeAnalysis() {
            const timeframeStats = {};

            trades.forEach(trade => {
                if (!timeframeStats[trade.timeframe]) {
                    timeframeStats[trade.timeframe] = { wins: 0, losses: 0, pnl: 0, total: 0 };
                }
                timeframeStats[trade.timeframe].total++;
                timeframeStats[trade.timeframe].pnl += trade.pnl;
                if (trade.pnl > 0) timeframeStats[trade.timeframe].wins++;
                else if (trade.pnl < 0) timeframeStats[trade.timeframe].losses++;
            });

            const container = document.getElementById('timeframeAnalysis');
            const sortedTimeframes = Object.entries(timeframeStats).sort((a, b) => b[1].pnl - a[1].pnl);

            container.innerHTML = sortedTimeframes.map(([timeframe, stats]) => {
                const winRate = stats.total > 0 ? (stats.wins / stats.total) * 100 : 0;
                const barWidth = winRate;
                const winRateLabel = winRate.toFixed(1);
                const barGradient = winRate >= 50
                    ? 'linear-gradient(90deg, var(--accent-primary), var(--accent-secondary))'
                    : 'linear-gradient(90deg, var(--accent-danger), #cc0033)';

                return `
                    <div class="comparison-row">
                        <div class="comparison-label">
                            <strong>${timeframe.toUpperCase()}</strong>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${stats.total} trades</div>
                        </div>
                        <div class="comparison-bar">
                            <div class="comparison-bar-fill" style="width: ${barWidth}%; background: ${barGradient}">
                                WR: ${winRateLabel}%
                            </div>
                        </div>
                        <div class="comparison-value" style="color: ${stats.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}">
                            ${formatCurrency(stats.pnl)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Top and Bottom Symbols
        function renderTopBottomSymbols() {
            const symbolStats = {};

            trades.forEach(trade => {
                if (!symbolStats[trade.symbol]) {
                    symbolStats[trade.symbol] = { wins: 0, losses: 0, pnl: 0, total: 0 };
                }
                symbolStats[trade.symbol].total++;
                symbolStats[trade.symbol].pnl += trade.pnl;
                if (trade.pnl > 0) symbolStats[trade.symbol].wins++;
                else if (trade.pnl < 0) symbolStats[trade.symbol].losses++;
            });

            const sortedSymbols = Object.entries(symbolStats).sort((a, b) => b[1].pnl - a[1].pnl);
            const topSymbols = sortedSymbols.slice(0, 5);
            const bottomSymbols = sortedSymbols.slice(-5).reverse();

            // Top Symbols
            const topContainer = document.getElementById('topSymbols');
            if (topSymbols.length === 0) {
                topContainer.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">No data yet</div>';
            } else {
                topContainer.innerHTML = topSymbols.map(([symbol, stats], index) => {
                    const winRate = ((stats.wins / stats.total) * 100).toFixed(1);
                    return `
                        <div class="symbol-card is-top">
                            <div class="symbol-card-header">
                                <div class="symbol-card-title">
                                    <span class="symbol-rank">#${index + 1}</span>
                                    <strong class="symbol-name">${symbol}</strong>
                                </div>
                                <strong class="symbol-pnl positive">${formatCurrency(stats.pnl)}</strong>
                            </div>
                            <div class="symbol-meta">
                                ${stats.total} trades ¬∑ Win Rate: ${winRate}% ¬∑ ${stats.wins}W - ${stats.losses}L
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Bottom Symbols
            const bottomContainer = document.getElementById('bottomSymbols');
            if (bottomSymbols.length === 0) {
                bottomContainer.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">No data yet</div>';
            } else {
                bottomContainer.innerHTML = bottomSymbols.map(([symbol, stats], index) => {
                    const winRate = ((stats.wins / stats.total) * 100).toFixed(1);
                    return `
                        <div class="symbol-card is-bottom">
                            <div class="symbol-card-header">
                                <div class="symbol-card-title">
                                    <span class="symbol-rank">#${index + 1}</span>
                                    <strong class="symbol-name">${symbol}</strong>
                                </div>
                                <strong class="symbol-pnl negative">${formatCurrency(stats.pnl)}</strong>
                            </div>
                            <div class="symbol-meta">
                                ${stats.total} trades ¬∑ Win Rate: ${winRate}% ¬∑ ${stats.wins}W - ${stats.losses}L
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Longest Streaks
        function calculateLongestStreaks() {
            let currentWinStreak = 0;
            let currentLossStreak = 0;
            let maxWinStreak = 0;
            let maxLossStreak = 0;

            const sortedTrades = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedTrades.forEach(trade => {
                if (trade.pnl > 0) {
                    currentWinStreak++;
                    currentLossStreak = 0;
                    maxWinStreak = Math.max(maxWinStreak, currentWinStreak);
                } else if (trade.pnl < 0) {
                    currentLossStreak++;
                    currentWinStreak = 0;
                    maxLossStreak = Math.max(maxLossStreak, currentLossStreak);
                }
            });

            document.getElementById('longestWinStreak').textContent = maxWinStreak;
            document.getElementById('longestLossStreak').textContent = maxLossStreak;
        }
        // ========== ANALYTICS TAB FUNCTIONS ==========
        function renderAnalytics() {
            const stats = calculateStats();

            document.getElementById('analyticsWinRate').textContent = stats.winRate.toFixed(1) + '%';
            document.getElementById('analyticsProfitFactor').textContent = stats.profitFactor.toFixed(2);
            
            // Calculate average R:R
            const avgRR = calculateAverageRR();
            document.getElementById('analyticsAvgRR').textContent = avgRR;

            // Expectancy
            const expectancy = TradeJournalAnalytics.expectancy(trades);
            document.getElementById('analyticsExpectancy').textContent = formatCurrency(expectancy);

            // Win/Loss distribution
            const winLossDiv = document.getElementById('winLossDistribution');
            winLossDiv.innerHTML = `
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 2rem; color: var(--accent-primary);">${stats.wins}</div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem;">Wins</div>
                    </div>
                    <div style="flex: 1; text-align: center;">
                        <div style="font-size: 2rem; color: var(--accent-danger);">${stats.losses}</div>
                        <div style="color: var(--text-secondary); font-size: 0.85rem;">Losses</div>
                    </div>
                </div>
            `;

            // Best/Worst days
            const dailyPnL = {};
            trades.forEach(trade => {
                const dateStr = trade.date.split('T')[0];
                if (!dailyPnL[dateStr]) dailyPnL[dateStr] = 0;
                dailyPnL[dateStr] += trade.pnl;
            });

            const sortedDays = Object.entries(dailyPnL).sort((a, b) => b[1] - a[1]);
            
            if (sortedDays.length > 0) {
                const best = sortedDays[0];
                document.getElementById('bestDay').textContent = formatCurrency(best[1]);
                document.getElementById('bestDayDate').textContent = formatDate(best[0]);

                const worst = sortedDays[sortedDays.length - 1];
                document.getElementById('worstDay').textContent = formatCurrency(worst[1]);
                document.getElementById('worstDayDate').textContent = formatDate(worst[0]);
            }

            // Setup performance chart
            renderSetupChart();

            // Symbol performance chart
            renderSymbolChart();

            // Time heatmap
            renderTimeHeatmap();

            // Emotion analysis
            renderEmotionAnalysis();

            // Streaks
            calculateAnalyticsStreaks();

            renderMonthlyHeatmap();
            renderStrategyPerformance();
        }

        function renderSetupChart() {
            const setupStats = {};

            trades.forEach(trade => {
                if (!setupStats[trade.setup]) {
                    setupStats[trade.setup] = 0;
                }
                setupStats[trade.setup] += trade.pnl;
            });

            const chart = document.getElementById('setupPerformanceChart');
            chart.innerHTML = '';

            if (Object.keys(setupStats).length === 0) {
                chart.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">No data yet</div>';
                return;
            }

            const maxPnL = Math.max(...Object.values(setupStats).map(Math.abs), 100);
            const sortedSetups = Object.entries(setupStats).sort((a, b) => b[1] - a[1]);

            sortedSetups.forEach(([setup, pnl]) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'chart-bar-wrapper';
                
                const height = (Math.abs(pnl) / maxPnL) * 100;
                const bar = document.createElement('div');
                bar.className = `chart-bar-modern ${pnl < 0 ? 'negative' : ''}`;
                bar.style.height = height + '%';
                
                const value = document.createElement('div');
                value.className = 'chart-bar-value';
                value.style.color = pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)';
                value.textContent = formatCurrency(pnl);
                
                const label = document.createElement('div');
                label.className = 'chart-bar-label';
                label.textContent = setup;
                
                bar.appendChild(value);
                wrapper.appendChild(bar);
                wrapper.appendChild(label);
                chart.appendChild(wrapper);
            });
        }

        function renderSymbolChart() {
            const symbolStats = {};

            trades.forEach(trade => {
                if (!symbolStats[trade.symbol]) {
                    symbolStats[trade.symbol] = 0;
                }
                symbolStats[trade.symbol] += trade.pnl;
            });

            const chart = document.getElementById('symbolPerformanceChart');
            chart.innerHTML = '';

            if (Object.keys(symbolStats).length === 0) {
                chart.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">No data yet</div>';
                return;
            }

            const maxPnL = Math.max(...Object.values(symbolStats).map(Math.abs), 100);
            const sortedSymbols = Object.entries(symbolStats).sort((a, b) => b[1] - a[1]).slice(0, 10);

            sortedSymbols.forEach(([symbol, pnl]) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'chart-bar-wrapper';
                
                const height = (Math.abs(pnl) / maxPnL) * 100;
                const bar = document.createElement('div');
                bar.className = `chart-bar-modern ${pnl < 0 ? 'negative' : ''}`;
                bar.style.height = height + '%';
                
                const value = document.createElement('div');
                value.className = 'chart-bar-value';
                value.style.color = pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)';
                value.textContent = formatCurrency(pnl);
                
                const label = document.createElement('div');
                label.className = 'chart-bar-label';
                label.textContent = symbol;
                
                bar.appendChild(value);
                wrapper.appendChild(bar);
                wrapper.appendChild(label);
                chart.appendChild(wrapper);
            });
        }

        function parseThemeColor(value) {
            if (!value) return { r: 0, g: 0, b: 0 };
            const trimmed = value.trim();
            if (trimmed.startsWith('rgb')) {
                const nums = trimmed.match(/\d+/g) || [0, 0, 0];
                return { r: Number(nums[0]), g: Number(nums[1]), b: Number(nums[2]) };
            }
            const hex = trimmed.replace('#', '');
            if (hex.length === 3) {
                const [r, g, b] = hex.split('').map(ch => parseInt(ch + ch, 16));
                return { r, g, b };
            }
            if (hex.length === 6) {
                return {
                    r: parseInt(hex.slice(0, 2), 16),
                    g: parseInt(hex.slice(2, 4), 16),
                    b: parseInt(hex.slice(4, 6), 16)
                };
            }
            return { r: 0, g: 0, b: 0 };
        }

        function mixThemeColors(base, neutral, weight) {
            const mix = (channelBase, channelNeutral) =>
                Math.round(channelNeutral + (channelBase - channelNeutral) * weight);
            return {
                r: mix(base.r, neutral.r),
                g: mix(base.g, neutral.g),
                b: mix(base.b, neutral.b)
            };
        }

        function renderTimeHeatmap() {
            const heatmap = document.getElementById('timeHeatmap');
            if (!heatmap) return;
            heatmap.innerHTML = '';

            const hourlyPnL = Array(24).fill(0);
            const hourlyCount = Array(24).fill(0);

            trades.forEach(trade => {
                const hour = new Date(trade.date).getHours();
                hourlyPnL[hour] += trade.pnl;
                hourlyCount[hour]++;
            });

            const maxPnL = Math.max(...hourlyPnL.map(Math.abs), 1);
            const styles = getComputedStyle(document.documentElement);
            const positive = parseThemeColor(styles.getPropertyValue('--accent-primary'));
            const negative = parseThemeColor(styles.getPropertyValue('--accent-danger'));
            const neutral = parseThemeColor(styles.getPropertyValue('--surface2'));

            const gradientStops = hourlyPnL.map((pnl, index) => {
                let color = neutral;
                if (hourlyCount[index] > 0) {
                    const intensity = Math.min(Math.abs(pnl) / maxPnL, 1);
                    const weight = 0.15 + Math.pow(intensity, 0.75) * 0.85;
                    const base = pnl >= 0 ? positive : negative;
                    color = mixThemeColors(base, neutral, weight);
                }
                const start = (index / 24) * 100;
                const end = ((index + 1) / 24) * 100;
                const rgb = `rgb(${color.r}, ${color.g}, ${color.b})`;
                return `${rgb} ${start}%, ${rgb} ${end}%`;
            });

            heatmap.style.background = `linear-gradient(90deg, ${gradientStops.join(', ')})`;

            const overlay = document.createElement('div');
            overlay.className = 'time-heatmap-overlay';

            for (let i = 0; i < 24; i++) {
                const cell = document.createElement('div');
                cell.className = 'time-heatmap-cell';
                cell.title = hourlyCount[i] > 0
                    ? `${i}:00 ‚Äî ${formatCurrency(hourlyPnL[i])} (${hourlyCount[i]} trades)`
                    : `${i}:00 ‚Äî No trades`;
                overlay.appendChild(cell);
            }

            heatmap.appendChild(overlay);
        }

        function renderMonthlyHeatmap() {
            const container = document.getElementById('monthlyHeatmap');
            if (!container) return;
            container.innerHTML = '';

            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
            const monthlyTrades = trades.filter(trade => trade.date.startsWith(monthKey));
            const dailyData = TradeJournalAnalytics.dailyAggregation(monthlyTrades);

            const dailyPnL = {};
            dailyData.forEach(day => {
                dailyPnL[day.date] = { pnl: day.pnl, count: day.count };
            });

            const values = Object.values(dailyPnL).map(day => Math.abs(day.pnl));
            const maxPnL = Math.max(...values, 1);

            const monthLabel = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const stats = calculateStats(monthlyTrades);

            const summary = document.createElement('div');
            summary.className = 'monthly-heatmap-summary';
            summary.innerHTML = `
                <div class="monthly-heatmap-title">${monthLabel}</div>
                <div class="monthly-heatmap-metrics">
                    <div class="monthly-heatmap-metric">
                        <span>Total P/L</span>
                        <strong class="${stats.totalPnL >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.totalPnL)}</strong>
                    </div>
                    <div class="monthly-heatmap-metric">
                        <span>Trades</span>
                        <strong>${monthlyTrades.length}</strong>
                    </div>
                    <div class="monthly-heatmap-metric">
                        <span>Win Rate</span>
                        <strong>${stats.winRate.toFixed(1)}%</strong>
                    </div>
                </div>
            `;

            const grid = document.createElement('div');
            grid.className = 'monthly-heatmap';

            const firstDay = new Date(year, month, 1);
            const startDay = firstDay.getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < startDay; i += 1) {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                cell.style.opacity = 0.2;
                grid.appendChild(cell);
            }

            for (let day = 1; day <= daysInMonth; day += 1) {
                const dateStr = `${monthKey}-${String(day).padStart(2, '0')}`;
                const data = dailyPnL[dateStr] || { pnl: 0, count: 0 };
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                cell.title = data.count > 0
                    ? `${dateStr}: ${formatCurrency(data.pnl)} (${data.count} trades)`
                    : `${dateStr}: No trades`;

                if (data.count > 0) {
                    const intensity = Math.min(Math.abs(data.pnl) / maxPnL, 1);
                    cell.style.background = data.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)';
                    cell.style.opacity = 0.25 + intensity * 0.75;
                    cell.style.color = '#fff';
                }

                cell.innerHTML = `<span>${day}</span>`;
                grid.appendChild(cell);
            }

            const legend = document.createElement('div');
            legend.className = 'heatmap-legend';
            legend.innerHTML = `<span>Daily P/L intensity</span><span>Hover cells for details</span>`;

            container.appendChild(summary);
            container.appendChild(grid);
            container.appendChild(legend);
        }

        function renderStrategyPerformance() {
            const tbody = document.getElementById('strategyPerformanceTable');
            if (!tbody) return;

            strategyPerformanceData = TradeJournalAnalytics.setupPerformance(trades);
            if (strategyPerformanceData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><span>üìä</span><div>No strategy data yet</div></div></td></tr>';
                return;
            }

            const sorted = sortStrategyData(strategyPerformanceData);
            tbody.innerHTML = sorted.map(item => {
                const pnlClass = item.pnl >= 0 ? 'positive' : 'negative';
                return `
                    <tr>
                        <td><strong>${item.setup}</strong></td>
                        <td>${item.trades}</td>
                        <td>${item.winRate.toFixed(1)}%</td>
                        <td class="${pnlClass}">${formatCurrency(item.pnl)}</td>
                        <td>${formatCurrency(item.avgWin)}</td>
                        <td>${formatCurrency(item.avgLoss)}</td>
                    </tr>
                `;
            }).join('');
        }

        function sortStrategyData(data) {
            const direction = strategySort.direction === 'asc' ? 1 : -1;
            const key = strategySort.key;
            return [...data].sort((a, b) => {
                if (key === 'setup') {
                    return a.setup.localeCompare(b.setup) * direction;
                }
                return ((a[key] || 0) - (b[key] || 0)) * direction;
            });
        }

        function sortStrategyTable(key) {
            if (strategySort.key === key) {
                strategySort.direction = strategySort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                strategySort.key = key;
                strategySort.direction = 'desc';
            }
            document.querySelectorAll('.table-sort').forEach(btn => {
                btn.classList.toggle('is-active', btn.dataset.sort === key);
            });
            renderStrategyPerformance();
        }

        function renderEmotionAnalysis() {
            const emotionStats = {};

            trades.forEach(trade => {
                if (trade.emotion) {
                    if (!emotionStats[trade.emotion]) {
                        emotionStats[trade.emotion] = { pnl: 0, count: 0, wins: 0 };
                    }
                    emotionStats[trade.emotion].pnl += trade.pnl;
                    emotionStats[trade.emotion].count++;
                    if (trade.pnl > 0) emotionStats[trade.emotion].wins++;
                }
            });

            const container = document.getElementById('emotionAnalysis');
            
            if (Object.keys(emotionStats).length === 0) {
                container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">No emotion data yet</div>';
                return;
            }

            container.innerHTML = Object.entries(emotionStats).map(([emotion, stats]) => {
                const winRate = (stats.wins / stats.count * 100).toFixed(1);
                const avgPnL = stats.pnl / stats.count;
                
                const pnlClass = stats.pnl >= 0 ? 'positive' : 'negative';
                return `
                    <div class="emotion-card">
                        <div class="emotion-header">
                            <strong class="emotion-name">${emotion}</strong>
                            <span class="emotion-pnl ${pnlClass}">${formatCurrency(stats.pnl)}</span>
                        </div>
                        <div class="emotion-meta">
                            Win Rate: ${winRate}% ¬∑ Avg P&L: ${formatCurrency(avgPnL)} ¬∑ Trades: ${stats.count}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculateAnalyticsStreaks() {
            let currentWinStreak = 0;
            let currentLossStreak = 0;
            let maxWinStreak = 0;
            let maxLossStreak = 0;

            const sortedTrades = [...trades].sort((a, b) => new Date(a.date) - new Date(b.date));

            sortedTrades.forEach(trade => {
                if (trade.pnl > 0) {
                    currentWinStreak++;
                    currentLossStreak = 0;
                    maxWinStreak = Math.max(maxWinStreak, currentWinStreak);
                } else if (trade.pnl < 0) {
                    currentLossStreak++;
                    currentWinStreak = 0;
                    maxLossStreak = Math.max(maxLossStreak, currentLossStreak);
                }
            });

            document.getElementById('longestWinStreakAnalytics').textContent = maxWinStreak;
            document.getElementById('longestLossStreakAnalytics').textContent = maxLossStreak;
        }
        // ========== CALENDAR FUNCTIONS ==========
        function renderCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // Calculate daily P&L
            const dailyPnL = {};
            trades.forEach(trade => {
                const dateStr = trade.date.split('T')[0];
                if (!dailyPnL[dateStr]) dailyPnL[dateStr] = 0;
                dailyPnL[dateStr] += trade.pnl;
            });

            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                grid.appendChild(emptyCell);
            }

            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const pnl = dailyPnL[dateStr] || 0;
                
                const cell = document.createElement('div');
                cell.className = 'calendar-day-cell';
                
                if (pnl > 0) {
                    cell.classList.add('is-positive');
                } else if (pnl < 0) {
                    cell.classList.add('is-negative');
                }
                
                cell.innerHTML = `
                    <div class="calendar-day-number">${day}</div>
                    ${pnl !== 0 ? `<div class="calendar-day-pnl ${pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(pnl)}</div>` : ''}
                `;
                
                cell.addEventListener('mouseover', function() {
                    this.classList.add('is-hovered');
                });
                
                cell.addEventListener('mouseout', function() {
                    this.classList.remove('is-hovered');
                });
                
                cell.onclick = () => showDayDetails(dateStr);
                grid.appendChild(cell);
            }

            updateMonthlyStats();
        }

        function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar();
        }

        function updateMonthlyStats() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            const monthTrades = trades.filter(trade => {
                const tradeDate = new Date(trade.date);
                return tradeDate.getFullYear() === year && tradeDate.getMonth() === month;
            });

            let totalPnL = 0;
            let wins = 0;
            const tradingDays = new Set();

            monthTrades.forEach(trade => {
                totalPnL += trade.pnl;
                if (trade.pnl > 0) wins++;
                tradingDays.add(trade.date.split('T')[0]);
            });

            const winRate = monthTrades.length > 0 ? (wins / monthTrades.length * 100).toFixed(1) : 0;

            document.getElementById('monthlyPnL').textContent = formatCurrency(totalPnL);
            document.getElementById('monthlyPnL').className = `metric-value ${totalPnL >= 0 ? 'positive' : 'negative'}`;
            document.getElementById('monthlyTradingDays').textContent = tradingDays.size;
            document.getElementById('monthlyTrades').textContent = monthTrades.length;
            document.getElementById('monthlyWinRate').textContent = winRate + '%';
        }

        function showDayDetails(dateStr) {
            const dayTrades = trades.filter(t => t.date.startsWith(dateStr));
            const notes = dailyNotes[dateStr] || [];

            const notesList = document.getElementById('dailyNotesList');
            
            let content = '';

            if (dayTrades.length > 0) {
                const dayPnL = dayTrades.reduce((sum, t) => sum + t.pnl, 0);
                content += `
                    <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 4px; margin-bottom: 1rem; border-left: 3px solid ${dayPnL >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'};">
                        <h4 style="margin-bottom: 0.5rem;">${formatDate(dateStr)}</h4>
                        <div style="font-size: 1.2rem; font-weight: bold; color: ${dayPnL >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}">
                            Daily P&L: ${formatCurrency(dayPnL)}
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                            ${dayTrades.length} trade${dayTrades.length > 1 ? 's' : ''}
                        </div>
                    </div>
                `;
                
                content += `<h4 style="margin-bottom: 1rem;">Trades (${dayTrades.length})</h4>`;
                dayTrades.forEach(trade => {
                    content += `
                        <div onclick="viewTradeDetails(${trade.id})" style="padding: 1rem; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 0.5rem; cursor: pointer; border-left: 3px solid ${trade.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}; transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span><strong>${trade.symbol}</strong> - ${trade.direction.toUpperCase()}</span>
                                <span style="color: ${trade.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}; font-weight: bold;">${formatCurrency(trade.pnl)}</span>
                            </div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${formatDateTime(trade.date)} | ${trade.setup}
                            </div>
                        </div>
                    `;
                });
            }

            if (notes.length > 0) {
                content += `<h4 style="margin: 1.5rem 0 1rem;">Notes (${notes.length})</h4>`;
                notes.forEach((note, index) => {
                    content += `
                        <div style="padding: 1rem; background: var(--bg-tertiary); border-radius: 4px; margin-bottom: 0.5rem; border-left: 3px solid var(--accent-secondary);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                                <span>${note.time}</span>
                                <button onclick="deleteNote('${dateStr}', ${index})" class="btn btn-danger btn-small" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Delete</button>
                            </div>
                            <div style="font-size: 0.95rem;">${note.text}</div>
                        </div>
                    `;
                });
            }

            if (!content) {
                content = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">No trades or notes for this day</div>';
            }

            notesList.innerHTML = content;
            notesList.dataset.selectedDate = dateStr;
        }

        function addDailyNote() {
            const selectedDate = document.getElementById('dailyNotesList').dataset.selectedDate;
            
            if (!selectedDate) {
                alert('Please select a day from the calendar first');
                return;
            }

            const text = prompt('Enter your note:');
            if (!text) return;

            const time = new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

            if (!dailyNotes[selectedDate]) dailyNotes[selectedDate] = [];
            dailyNotes[selectedDate].push({ time, text });

            localStorage.setItem('dailyNotes', JSON.stringify(dailyNotes));
            showDayDetails(selectedDate);
        }

        function deleteNote(dateStr, index) {
            if (!confirm('Delete this note?')) return;

            dailyNotes[dateStr].splice(index, 1);
            if (dailyNotes[dateStr].length === 0) {
                delete dailyNotes[dateStr];
            }

            localStorage.setItem('dailyNotes', JSON.stringify(dailyNotes));
            showDayDetails(dateStr);
        }
        // ========== SETTINGS FUNCTIONS ==========
        function loadSettings() {
            document.getElementById('settingStartingCapital').value = settings.startingCapital;
            document.getElementById('settingRiskPerTrade').value = settings.riskPerTrade;
            document.getElementById('settingDailyLossLimit').value = settings.dailyLossLimit;
            document.getElementById('settingDailyGoal').value = settings.dailyGoal;
            document.getElementById('settingWeeklyGoal').value = settings.weeklyGoal;
            document.getElementById('settingMonthlyGoal').value = settings.monthlyGoal;
            document.getElementById('settingTargetWinRate').value = settings.targetWinRate;
            document.getElementById('settingMaxTrades').value = settings.maxTrades;
        }

        async function saveSettings() {
            settings = {
                startingCapital: parseFloat(document.getElementById('settingStartingCapital').value) || 10000,
                riskPerTrade: parseFloat(document.getElementById('settingRiskPerTrade').value) || 1,
                dailyLossLimit: parseFloat(document.getElementById('settingDailyLossLimit').value) || 3,
                dailyGoal: parseFloat(document.getElementById('settingDailyGoal').value) || 500,
                weeklyGoal: parseFloat(document.getElementById('settingWeeklyGoal').value) || 2500,
                monthlyGoal: parseFloat(document.getElementById('settingMonthlyGoal').value) || 10000,
                targetWinRate: parseFloat(document.getElementById('settingTargetWinRate').value) || 60,
                maxTrades: parseFloat(document.getElementById('settingMaxTrades').value) || 5
            };

            localStorage.setItem('settings', JSON.stringify(settings));
            if (isDbReady) {
                await TradeJournalDB.saveSetting('settings', settings);
            }
            showToast('Settings saved', 'success');
        }

        // ========== SESSION MANAGEMENT ==========
        function loadSessions() {
            const container = document.getElementById('sessionsContainer');
            container.innerHTML = '';

            tradingSessions.forEach((session, index) => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';
                sessionItem.innerHTML = `
                    <input type="text" class="form-input" placeholder="Session Name" value="${session.name}" id="session${index}Name">
                    <input type="time" class="form-input" value="${session.start}" id="session${index}Start">
                    <input type="time" class="form-input" value="${session.end}" id="session${index}End">
                    <button class="btn btn-danger btn-small" onclick="removeSession(${index})">Remove</button>
                `;
                container.appendChild(sessionItem);
            });

            sessionCounter = tradingSessions.length;
        }

        function addTradingSession() {
            const container = document.getElementById('sessionsContainer');
            const index = sessionCounter;
            
            const sessionItem = document.createElement('div');
            sessionItem.className = 'session-item';
            sessionItem.id = `sessionItem${index}`;
            sessionItem.innerHTML = `
                <input type="text" class="form-input" placeholder="Session Name" id="session${index}Name">
                <input type="time" class="form-input" value="09:00" id="session${index}Start">
                <input type="time" class="form-input" value="17:00" id="session${index}End">
                <button class="btn btn-danger btn-small" onclick="removeSession(${index})">Remove</button>
            `;
            container.appendChild(sessionItem);
            sessionCounter++;
        }

        function removeSession(index) {
            const sessionItem = document.getElementById(`sessionItem${index}`);
            if (sessionItem) {
                sessionItem.remove();
            } else {
                // For pre-loaded sessions, just hide them
                const container = document.getElementById('sessionsContainer');
                const items = container.children;
                if (items[index]) {
                    items[index].remove();
                }
            }
        }

        function saveSessions() {
            tradingSessions = [];
            const container = document.getElementById('sessionsContainer');
            const sessionItems = container.querySelectorAll('.session-item');

            sessionItems.forEach((item, index) => {
                const nameInput = item.querySelector('input[type="text"]');
                const startInput = item.querySelectorAll('input[type="time"]')[0];
                const endInput = item.querySelectorAll('input[type="time"]')[1];

                if (nameInput && startInput && endInput) {
                    const name = nameInput.value.trim();
                    const start = startInput.value;
                    const end = endInput.value;

                    if (name && start && end) {
                        tradingSessions.push({ name, start, end });
                    }
                }
            });

            localStorage.setItem('tradingSessions', JSON.stringify(tradingSessions));
            alert('‚úÖ Trading sessions saved successfully!');
            renderSessionAnalysis();
        }

        // ========== DATA MANAGEMENT ==========
        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function getAllTradesForExport() {
            if (isDbReady) {
                return TradeJournalDB.getAllTrades();
            }
            return Object.values(allTrades).flat();
        }

        function groupTradesByAccount(tradeList) {
            const grouped = {};
            tradeList.forEach(trade => {
                const accountId = trade.account || currentAccount;
                if (!grouped[accountId]) grouped[accountId] = [];
                grouped[accountId].push(stripTradeImages(trade));
            });
            return grouped;
        }
        async function exportData() {
            const tradeList = await getAllTradesForExport();
            const serializedTrades = await TradeJournalReports.serializeTrades(tradeList);
            const views = isDbReady ? await TradeJournalDB.getViews() : [];

            const data = {
                accounts,
                trades: serializedTrades,
                allTrades: groupTradesByAccount(serializedTrades),
                settings,
                tradingSessions,
                dailyNotes,
                strategies,
                tradingRules,
                views,
                currentAccount,
                exportDate: new Date().toISOString(),
                version: '3.0'
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            downloadBlob(blob, `trading-journal-backup-${new Date().toISOString().split('T')[0]}.json`);
            showToast('Export completed', 'success');
        }

        async function exportCSV() {
            const headers = ['Date', 'Account', 'Symbol', 'Direction', 'Entry', 'Exit', 'Quantity', 'P&L', 'Setup', 'Timeframe', 'Followed Plan', 'Emotion', 'Notes'];
            const tradeList = await getAllTradesForExport();
            const rows = tradeList.map(trade => {
                const accountName = accounts[trade.account]?.name || trade.account || currentAccount;
                return [
                    trade.date,
                    accountName,
                    trade.symbol,
                    trade.direction,
                    trade.entry,
                    trade.exit,
                    trade.quantity,
                    trade.pnl,
                    trade.setup,
                    trade.timeframe,
                    trade.followedPlan === 'yes' ? 'Yes' : 'No',
                    trade.emotion || '',
                    `"${(trade.notes || '').replace(/"/g, '""')}"`
                ];
            });

            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            downloadBlob(blob, `trading-journal-${new Date().toISOString().split('T')[0]}.csv`);
            showToast('CSV exported', 'success');
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        async function handleImportedData(data) {
            if (data.accounts) accounts = data.accounts;
            if (data.settings) settings = data.settings;
            if (data.tradingSessions) tradingSessions = data.tradingSessions;
            if (data.dailyNotes) dailyNotes = data.dailyNotes;
            if (data.strategies) strategies = data.strategies;
            if (data.tradingRules) tradingRules = data.tradingRules;
            if (data.currentAccount) currentAccount = data.currentAccount;

            const importedTrades = data.trades
                ? TradeJournalReports.deserializeTrades(data.trades)
                : TradeJournalReports.deserializeTrades(
                    Object.values(data.allTrades || {}).flat()
                );

            allTrades = groupTradesByAccount(importedTrades);
            trades = allTrades[currentAccount] || [];

            if (isDbReady) {
                await TradeJournalDB.clearTrades();
                await TradeJournalDB.clearViews();
                await TradeJournalDB.saveTradesBulk(importedTrades);

                if (data.views) {
                    for (const view of data.views) {
                        await TradeJournalDB.saveView(view);
                    }
                }
                await TradeJournalDB.saveSetting('settings', settings);
            }

            localStorage.setItem('accounts', JSON.stringify(accounts));
            localStorage.setItem('allTrades', JSON.stringify(allTrades));
            localStorage.setItem('settings', JSON.stringify(settings));
            localStorage.setItem('tradingSessions', JSON.stringify(tradingSessions));
            localStorage.setItem('dailyNotes', JSON.stringify(dailyNotes));
            localStorage.setItem('strategies', JSON.stringify(strategies));
            localStorage.setItem('tradingRules', JSON.stringify(tradingRules));
            localStorage.setItem('currentAccount', currentAccount);

            showToast('Import completed', 'success');
            location.reload();
        }

        document.getElementById('importFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (!confirm('This will replace all existing data. Are you sure?\n\nMake sure you have exported a backup first!')) {
                        return;
                    }

                    await handleImportedData(data);
                } catch (error) {
                    alert('‚ùå Error importing data. Please check the file format.\n\nError: ' + error.message);
                }
            };
            reader.readAsText(file);
        });

        async function exportEncryptedBackup() {
            const password = prompt('Create a password for your encrypted backup:');
            if (!password) return;

            const tradeList = await getAllTradesForExport();
            const serializedTrades = await TradeJournalReports.serializeTrades(tradeList);
            const views = isDbReady ? await TradeJournalDB.getViews() : [];

            const payload = {
                accounts,
                trades: serializedTrades,
                settings,
                tradingSessions,
                dailyNotes,
                strategies,
                tradingRules,
                views,
                currentAccount,
                exportDate: new Date().toISOString(),
                version: '3.0'
            };

            const encrypted = await TradeJournalReports.encryptString(JSON.stringify(payload), password);
            const blob = new Blob([JSON.stringify(encrypted, null, 2)], { type: 'application/json' });
            downloadBlob(blob, `trading-journal-encrypted-${new Date().toISOString().split('T')[0]}.json`);
            showToast('Encrypted backup saved', 'success');
        }

        function importEncryptedBackup() {
            document.getElementById('encryptedImportFile').click();
        }

        document.getElementById('encryptedImportFile').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const password = prompt('Enter the password for this backup:');
            if (!password) return;

            const reader = new FileReader();
            reader.onload = async function(event) {
                try {
                    const encrypted = JSON.parse(event.target.result);
                    const json = await TradeJournalReports.decryptString(encrypted, password);
                    const data = JSON.parse(json);

                    if (!confirm('This will replace all existing data. Continue?')) {
                        return;
                    }

                    await handleImportedData(data);
                } catch (error) {
                    alert('‚ùå Unable to decrypt backup. Check the password and try again.');
                }
            };
            reader.readAsText(file);
        });

        function openMonthlyReport() {
            const report = document.getElementById('printReport');
            const now = new Date();
            const monthLabel = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const monthlyKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

            const monthlyTrades = trades.filter(trade => trade.date.startsWith(monthlyKey));
            const stats = calculateStats(monthlyTrades);
            const equityCurve = TradeJournalAnalytics.equityCurve(monthlyTrades);
            const heatmapData = TradeJournalAnalytics.dailyAggregation(monthlyTrades);
            const strategies = TradeJournalAnalytics.setupPerformance(monthlyTrades).slice(0, 5);

            const heatmapValues = heatmapData.map(day => Math.abs(day.pnl));
            const heatmapMax = Math.max(...heatmapValues, 1);
            const heatmapCells = heatmapData.map(day => `
                <div class="heatmap-cell" style="background: ${day.pnl >= 0 ? 'var(--accent-primary)' : 'var(--accent-danger)'}; opacity: ${Math.min(Math.abs(day.pnl) / heatmapMax, 1) * 0.8 + 0.2}; color: #fff;">
                    <span>${day.date.split('-')[2]}</span>
                </div>
            `).join('');

            report.innerHTML = `
                <div class="report-header">
                    <div>
                        <h1>Monthly Trading Report</h1>
                        <div>${monthLabel} ‚Äî ${accounts[currentAccount]?.name || 'Account'}</div>
                    </div>
                    <div>${new Date().toLocaleDateString()}</div>
                </div>
                <div class="report-kpis">
                    <div class="report-kpi">
                        <div class="metric-label">Total P&L</div>
                        <div class="metric-value ${stats.totalPnL >= 0 ? 'positive' : 'negative'}">${formatCurrency(stats.totalPnL)}</div>
                    </div>
                    <div class="report-kpi">
                        <div class="metric-label">Win Rate</div>
                        <div class="metric-value">${stats.winRate.toFixed(1)}%</div>
                    </div>
                    <div class="report-kpi">
                        <div class="metric-label">Trades</div>
                        <div class="metric-value">${monthlyTrades.length}</div>
                    </div>
                    <div class="report-kpi">
                        <div class="metric-label">Expectancy</div>
                        <div class="metric-value">${formatCurrency(TradeJournalAnalytics.expectancy(monthlyTrades))}</div>
                    </div>
                </div>
                <div class="report-section">
                    <h3>Equity Curve</h3>
                    ${TradeJournalReports.buildEquityCurveSvg(equityCurve)}
                </div>
                <div class="report-section">
                    <h3>Monthly Heatmap</h3>
                    <div class="monthly-heatmap">${heatmapCells || '<div class="report-empty">No trades yet.</div>'}</div>
                </div>
                <div class="report-section">
                    <h3>Top Strategies</h3>
                    <table class="strategy-table">
                        <thead>
                            <tr>
                                <th>Setup</th>
                                <th>Trades</th>
                                <th>Win Rate</th>
                                <th>Net P&L</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${strategies.length ? strategies.map(strategy => `
                                <tr>
                                    <td>${strategy.setup}</td>
                                    <td>${strategy.trades}</td>
                                    <td>${strategy.winRate.toFixed(1)}%</td>
                                    <td>${formatCurrency(strategy.pnl)}</td>
                                </tr>
                            `).join('') : '<tr><td colspan="4" class="report-empty">No strategy data yet</td></tr>'}
                        </tbody>
                    </table>
                </div>
                <div class="report-section">
                    <h3>Recent Trades</h3>
                    <table class="journal-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Symbol</th>
                                <th>Direction</th>
                                <th>P&L</th>
                                <th>Setup</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${monthlyTrades.slice(-10).reverse().map(trade => `
                                <tr>
                                    <td>${formatDateTime(trade.date)}</td>
                                    <td>${trade.symbol}</td>
                                    <td>${trade.direction.toUpperCase()}</td>
                                    <td>${formatCurrency(trade.pnl)}</td>
                                    <td>${trade.setup}</td>
                                </tr>
                            `).join('') || '<tr><td colspan="5" class="report-empty">No trades to display</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;

            window.print();
        }

        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL data from ALL accounts!\n\nThis action cannot be undone. Are you absolutely sure?')) {
                return;
            }
            
            if (!confirm('This is your last chance! All trades, notes, and settings will be permanently deleted.\n\nType YES in the next prompt to confirm.')) {
                return;
            }

            const confirmation = prompt('Type YES to confirm deletion:');
            if (confirmation !== 'YES') {
                alert('Deletion cancelled.');
                return;
            }

            localStorage.clear();
            if (isDbReady) {
                await TradeJournalDB.clearTrades();
                await TradeJournalDB.clearViews();
                await TradeJournalDB.saveSetting('migration_done', true);
            }
            alert('All data has been deleted. The page will now reload.');
            location.reload();
        }

        // ========== PLAYBOOK ==========
                // ========== PLAYBOOK FUNCTIONS ==========
        function renderPlaybook() {
            const container = document.getElementById('strategiesContainer');
            const accountStrategies = strategies[currentAccount] || [];
            const snapshot = document.getElementById('playbookPerformanceSnapshot');

            if (accountStrategies.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìö</div>
                        <div style="font-size: 1.2rem; margin-bottom: 0.5rem;">No Strategies Yet</div>
                        <div>Click "Add Strategy" to create your first trading strategy</div>
                    </div>
                `;
                if (snapshot) {
                    snapshot.innerHTML = `
                        <div class="empty-state">
                            <span>üìà</span>
                            <div>Track trades to populate setup performance insights.</div>
                        </div>
                    `;
                }
                return;
            }

            container.innerHTML = accountStrategies.map(strategy => {
                const stats = calculateStrategyStats(strategy.id);
                const winRate = stats.total > 0 ? ((stats.wins / stats.total) * 100).toFixed(1) : 0;

                return `
                    <div class="card strategy-card">
                        <div class="card-header">
                            <div class="card-title">${strategy.name}</div>
                            <div style="display: flex; gap: 0.5rem;">
                                ${stats.total > 0 ? `<span class="badge badge-${stats.winRate >= 50 ? 'win' : 'loss'}">WR: ${winRate}%</span>` : ''}
                                <button class="btn btn-secondary btn-small" onclick="editStrategy('${strategy.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-danger btn-small" onclick="deleteStrategy('${strategy.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom: 0.5rem; color: var(--accent-primary);">Entry Criteria:</h4>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem; color: var(--text-secondary);">
                                ${strategy.entryCriteria.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                            
                            <h4 style="margin-bottom: 0.5rem; color: var(--accent-primary);">Exit Criteria:</h4>
                            <ul style="margin-left: 1.5rem; margin-bottom: 1rem; color: var(--text-secondary);">
                                ${strategy.exitCriteria.map(c => `<li>${c}</li>`).join('')}
                            </ul>

                            ${strategy.timeframes.length > 0 ? `
                                <h4 style="margin-bottom: 0.5rem; color: var(--accent-primary);">Best Timeframes:</h4>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                                    ${strategy.timeframes.map(tf => `<span class="badge">${tf}</span>`).join('')}
                                </div>
                            ` : ''}

                            ${strategy.checklistTemplate && strategy.checklistTemplate.length ? `
                                <h4 style="margin-bottom: 0.5rem; color: var(--accent-primary);">Checklist Template:</h4>
                                <ul style="margin-left: 1.5rem; margin-bottom: 1rem; color: var(--text-secondary);">
                                    ${strategy.checklistTemplate.map(item => `<li>${item}</li>`).join('')}
                                </ul>
                            ` : ''}

                            ${strategy.notesTemplate ? `
                                <h4 style="margin-bottom: 0.5rem; color: var(--accent-primary);">Notes Template:</h4>
                                <div style="color: var(--text-secondary); margin-bottom: 1rem;">${strategy.notesTemplate}</div>
                            ` : ''}

                            ${strategy.notes ? `
                                <h4 style="margin-bottom: 0.5rem; color: var(--accent-primary);">Notes:</h4>
                                <div style="color: var(--text-secondary); margin-bottom: 1rem;">${strategy.notes}</div>
                            ` : ''}

                            ${stats.total > 0 ? `
                                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                                    <div style="display: flex; justify-content: space-between; color: var(--text-secondary); font-size: 0.85rem;">
                                        <span>Trades: ${stats.total}</span>
                                        <span>Avg P&L: ${formatCurrency(stats.avgPnL)}</span>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            renderPlaybookSnapshot();
        }

        function renderPlaybookSnapshot() {
            const snapshot = document.getElementById('playbookPerformanceSnapshot');
            if (!snapshot) return;
            const setupStats = TradeJournalAnalytics.setupPerformance(trades);
            if (!setupStats.length) {
                snapshot.innerHTML = `
                    <div class="empty-state">
                        <span>üìà</span>
                        <div>Track trades to populate setup performance insights.</div>
                    </div>
                `;
                return;
            }

            const top = setupStats.slice(0, 4);
            snapshot.innerHTML = `
                <div class="snapshot-grid">
                    ${top.map(setup => `
                        <div class="snapshot-card">
                            <div class="snapshot-title">${setup.setup}</div>
                            <div class="snapshot-value ${setup.pnl >= 0 ? 'positive' : 'negative'}">${formatCurrency(setup.pnl)}</div>
                            <div class="snapshot-meta">${setup.trades} trades ¬∑ ${setup.winRate.toFixed(1)}% WR</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function calculateStrategyStats(strategyId) {
            const strategy = strategies[currentAccount]?.find(s => s.id === strategyId);
            if (!strategy) return { wins: 0, total: 0, avgPnL: 0, winRate: 0 };

            const strategyTrades = trades.filter(t => t.setup === strategy.name.toLowerCase().replace(/\s+/g, '-'));
            
            let wins = 0;
            let totalPnL = 0;

            strategyTrades.forEach(trade => {
                totalPnL += trade.pnl;
                if (trade.pnl > 0) wins++;
            });

            const avgPnL = strategyTrades.length > 0 ? totalPnL / strategyTrades.length : 0;
            const winRate = strategyTrades.length > 0 ? (wins / strategyTrades.length) * 100 : 0;

            return {
                wins,
                total: strategyTrades.length,
                avgPnL,
                winRate
            };
        }

        function openAddStrategyModal() {
            document.getElementById('strategyModalTitle').textContent = 'Add New Strategy';
            document.getElementById('strategyName').value = '';
            document.getElementById('strategyNotes').value = '';
            document.getElementById('strategyChecklistTemplate').value = '';
            document.getElementById('strategyNotesTemplate').value = '';
            document.getElementById('editingStrategyId').value = '';
            document.getElementById('entryCriteriaList').innerHTML = '';
            document.getElementById('exitCriteriaList').innerHTML = '';
            
            // Uncheck all timeframes
            document.querySelectorAll('#timeframeSelector input[type="checkbox"]').forEach(cb => cb.checked = false);

            // Add initial empty criteria
            addCriteriaItem('entry');
            addCriteriaItem('exit');

            document.getElementById('strategyModal').classList.add('active');
        }

        function addCriteriaItem(type) {
            const container = type === 'entry' ? document.getElementById('entryCriteriaList') : document.getElementById('exitCriteriaList');
            const index = container.children.length;

            const item = document.createElement('div');
            item.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            item.innerHTML = `
                <input type="text" class="form-input" placeholder="Enter criterion..." data-type="${type}">
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">‚úï</button>
            `;
            container.appendChild(item);
        }

        function editStrategy(strategyId) {
            const strategy = strategies[currentAccount]?.find(s => s.id === strategyId);
            if (!strategy) return;

            document.getElementById('strategyModalTitle').textContent = 'Edit Strategy';
            document.getElementById('strategyName').value = strategy.name;
            document.getElementById('strategyNotes').value = strategy.notes || '';
            document.getElementById('strategyChecklistTemplate').value = (strategy.checklistTemplate || []).join('\n');
            document.getElementById('strategyNotesTemplate').value = strategy.notesTemplate || '';
            document.getElementById('editingStrategyId').value = strategyId;

            // Populate entry criteria
            const entryCriteriaList = document.getElementById('entryCriteriaList');
            entryCriteriaList.innerHTML = '';
            strategy.entryCriteria.forEach(criterion => {
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
                item.innerHTML = `
                    <input type="text" class="form-input" value="${criterion}" data-type="entry">
                    <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">‚úï</button>
                `;
                entryCriteriaList.appendChild(item);
            });

            // Populate exit criteria
            const exitCriteriaList = document.getElementById('exitCriteriaList');
            exitCriteriaList.innerHTML = '';
            strategy.exitCriteria.forEach(criterion => {
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
                item.innerHTML = `
                    <input type="text" class="form-input" value="${criterion}" data-type="exit">
                    <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">‚úï</button>
                `;
                exitCriteriaList.appendChild(item);
            });

            // Set timeframes
            document.querySelectorAll('#timeframeSelector input[type="checkbox"]').forEach(cb => {
                cb.checked = strategy.timeframes.includes(cb.value);
            });

            document.getElementById('strategyModal').classList.add('active');
        }

        function saveStrategy() {
            const name = document.getElementById('strategyName').value.trim();
            const notes = document.getElementById('strategyNotes').value.trim();
            const checklistTemplateRaw = document.getElementById('strategyChecklistTemplate').value;
            const notesTemplate = document.getElementById('strategyNotesTemplate').value.trim();
            const editingId = document.getElementById('editingStrategyId').value;

            if (!name) {
                alert('Please enter a strategy name');
                return;
            }

            // Get entry criteria
            const entryCriteria = [];
            document.querySelectorAll('#entryCriteriaList input[data-type="entry"]').forEach(input => {
                const value = input.value.trim();
                if (value) entryCriteria.push(value);
            });

            if (entryCriteria.length === 0) {
                alert('Please add at least one entry criterion');
                return;
            }

            // Get exit criteria
            const exitCriteria = [];
            document.querySelectorAll('#exitCriteriaList input[data-type="exit"]').forEach(input => {
                const value = input.value.trim();
                if (value) exitCriteria.push(value);
            });

            if (exitCriteria.length === 0) {
                alert('Please add at least one exit criterion');
                return;
            }

            // Get selected timeframes
            const timeframes = [];
            document.querySelectorAll('#timeframeSelector input[type="checkbox"]:checked').forEach(cb => {
                timeframes.push(cb.value);
            });

            const checklistTemplate = checklistTemplateRaw
                .split('\n')
                .map(line => line.trim())
                .filter(Boolean);

            const strategyData = {
                id: editingId || 'strategy_' + Date.now(),
                name,
                entryCriteria,
                exitCriteria,
                timeframes,
                notes,
                checklistTemplate,
                notesTemplate,
                createdAt: editingId ? undefined : new Date().toISOString()
            };

            if (!strategies[currentAccount]) {
                strategies[currentAccount] = [];
            }

            if (editingId) {
                // Update existing strategy
                const index = strategies[currentAccount].findIndex(s => s.id === editingId);
                if (index !== -1) {
                    strategies[currentAccount][index] = { ...strategies[currentAccount][index], ...strategyData };
                }
            } else {
                // Add new strategy
                strategies[currentAccount].push(strategyData);
            }

            localStorage.setItem('strategies', JSON.stringify(strategies));
            
            // Update setup dropdown in new trade form
            updateSetupDropdown();

            closeModal('strategyModal');
            renderPlaybook();
            alert('‚úÖ Strategy saved successfully!');
        }

        function deleteStrategy(strategyId) {
            const strategy = strategies[currentAccount]?.find(s => s.id === strategyId);
            if (!strategy) return;

            // Check if strategy is used in any trades
            const strategySlug = strategy.name.toLowerCase().replace(/\s+/g, '-');
            const usedInTrades = trades.filter(t => t.setup === strategySlug);

            let confirmMessage = `Delete strategy "${strategy.name}"?\n\n`;
            
            if (usedInTrades.length > 0) {
                confirmMessage += `‚ö†Ô∏è WARNING: This strategy has been used in ${usedInTrades.length} trade${usedInTrades.length > 1 ? 's' : ''}!\n\n`;
                confirmMessage += `Deleting this strategy will NOT delete the trades, but they will no longer be linked to this strategy.\n\n`;
                confirmMessage += `Are you sure you want to proceed?`;
            } else {
                confirmMessage += `This action cannot be undone.`;
            }

            if (!confirm(confirmMessage)) return;

            // Double confirmation for strategies with trades
            if (usedInTrades.length > 0) {
                if (!confirm(`Final confirmation: Delete "${strategy.name}" even though it has ${usedInTrades.length} trade${usedInTrades.length > 1 ? 's' : ''}?`)) {
                    return;
                }
            }

            strategies[currentAccount] = strategies[currentAccount].filter(s => s.id !== strategyId);
            localStorage.setItem('strategies', JSON.stringify(strategies));

            updateSetupDropdown();
            renderPlaybook();
            alert('‚úÖ Strategy deleted successfully.');
        }

        function updateSetupDropdown() {
            const setupSelect = document.getElementById('tradeSetup');
            if (!setupSelect) return;

            const accountStrategies = strategies[currentAccount] || [];
            const strategyOptions = accountStrategies.map(s => {
                const slug = s.name.toLowerCase().replace(/\s+/g, '-');
                return `<option value="${slug}">${s.name}</option>`;
            }).join('');

            setupSelect.innerHTML = `
                ${strategyOptions}
                <option value="other">Other</option>
            `;
            updateStrategyTemplate();
        }

        // Trading Rules Functions
        function renderTradingRules() {
            const container = document.getElementById('tradingRulesDisplay');
            
            container.innerHTML = `
                <div>
                    <h4 style="margin-bottom: 1rem; color: var(--accent-primary);">Risk Management</h4>
                    <ul style="margin-left: 1.5rem; color: var(--text-secondary); line-height: 1.8;">
                        ${tradingRules.risk.map(rule => `<li>${rule}</li>`).join('')}
                    </ul>
                </div>
                <div>
                    <h4 style="margin-bottom: 1rem; color: var(--accent-primary);">Mental Game</h4>
                    <ul style="margin-left: 1.5rem; color: var(--text-secondary); line-height: 1.8;">
                        ${tradingRules.mental.map(rule => `<li>${rule}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        function openEditRulesModal() {
            // Populate risk management rules
            const riskList = document.getElementById('riskManagementList');
            riskList.innerHTML = '';
            tradingRules.risk.forEach(rule => {
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
                item.innerHTML = `
                    <input type="text" class="form-input" value="${rule}" data-type="risk">
                    <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">‚úï</button>
                `;
                riskList.appendChild(item);
            });

            // Populate mental game rules
            const mentalList = document.getElementById('mentalGameList');
            mentalList.innerHTML = '';
            tradingRules.mental.forEach(rule => {
                const item = document.createElement('div');
                item.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
                item.innerHTML = `
                    <input type="text" class="form-input" value="${rule}" data-type="mental">
                    <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">‚úï</button>
                `;
                mentalList.appendChild(item);
            });

            document.getElementById('editRulesModal').classList.add('active');
        }

        function addRuleItem(type) {
            const container = type === 'risk' ? document.getElementById('riskManagementList') : document.getElementById('mentalGameList');
            
            const item = document.createElement('div');
            item.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem;';
            item.innerHTML = `
                <input type="text" class="form-input" placeholder="Enter rule..." data-type="${type}">
                <button type="button" class="btn btn-danger btn-small" onclick="this.parentElement.remove()">‚úï</button>
            `;
            container.appendChild(item);
        }

        function saveTradingRules() {
            const risk = [];
            document.querySelectorAll('#riskManagementList input[data-type="risk"]').forEach(input => {
                const value = input.value.trim();
                if (value) risk.push(value);
            });

            const mental = [];
            document.querySelectorAll('#mentalGameList input[data-type="mental"]').forEach(input => {
                const value = input.value.trim();
                if (value) mental.push(value);
            });

            tradingRules = { risk, mental };
            localStorage.setItem('tradingRules', JSON.stringify(tradingRules));

            closeModal('editRulesModal');
            renderTradingRules();
            alert('‚úÖ Trading rules saved successfully!');
        }
    </script>
</body>
</html>
